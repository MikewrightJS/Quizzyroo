{"ast":null,"code":"// Copyright 2011 Timothy J Fontaine <tjfontaine@gmail.com>\n//\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n//\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n// THE SOFTWARE\n'use strict';\n\nvar ipaddr = require('ipaddr.js'),\n    net = require('net'),\n    util = require('util'),\n    EventEmitter = require('events').EventEmitter,\n    PendingRequests = require('./pending'),\n    Packet = require('./packet'),\n    consts = require('native-dns-packet').consts,\n    utils = require('./utils'),\n    platform = require('./platform');\n\nvar A = consts.NAME_TO_QTYPE.A,\n    AAAA = consts.NAME_TO_QTYPE.AAAA,\n    MX = consts.NAME_TO_QTYPE.MX,\n    TXT = consts.NAME_TO_QTYPE.TXT,\n    NS = consts.NAME_TO_QTYPE.NS,\n    CNAME = consts.NAME_TO_QTYPE.CNAME,\n    SRV = consts.NAME_TO_QTYPE.SRV,\n    PTR = consts.NAME_TO_QTYPE.PTR;\n\nvar debug = function () {};\n\nif (process.env.NODE_DEBUG && process.env.NODE_DEBUG.match(/dns/)) {\n  debug = function debug() {\n    var args = Array.prototype.slice.call(arguments);\n    console.error.apply(this, ['client', Date.now().toString()].concat(args));\n  };\n}\n\nvar Request = exports.Request = function (opts) {\n  if (!(this instanceof Request)) return new Request(opts);\n  this.question = opts.question;\n  this.server = opts.server;\n  if (typeof this.server === 'string' || this.server instanceof String) this.server = {\n    address: this.server,\n    port: 53,\n    type: 'udp'\n  };\n  if (!this.server || !this.server.address || !net.isIP(this.server.address)) throw new Error('Server object must be supplied with at least address');\n  if (!this.server.type || ['udp', 'tcp'].indexOf(this.server.type) === -1) this.server.type = 'udp';\n  if (!this.server.port) this.server.port = 53;\n  this.timeout = opts.timeout || 4 * 1000;\n  this.try_edns = opts.try_edns || false;\n  this.fired = false;\n  this.id = undefined;\n\n  if (opts.cache || opts.cache === false) {\n    this.cache = opts.cache;\n  } else {\n    this.cache = platform.cache;\n  }\n\n  debug('request created', this.question);\n};\n\nutil.inherits(Request, EventEmitter);\n\nRequest.prototype.handle = function (err, answer, cached) {\n  if (!this.fired) {\n    debug('request handled', this.id, this.question);\n\n    if (!cached && this.cache && this.cache.store && answer) {\n      this.cache.store(answer);\n    }\n\n    this.emit('message', err, answer);\n    this.done();\n  }\n};\n\nRequest.prototype.done = function () {\n  debug('request finished', this.id, this.question);\n  this.fired = true;\n  clearTimeout(this.timer_);\n  PendingRequests.remove(this);\n  this.emit('end');\n  this.id = undefined;\n};\n\nRequest.prototype.handleTimeout = function () {\n  if (!this.fired) {\n    debug('request timedout', this.id, this.question);\n    this.emit('timeout');\n    this.done();\n  }\n};\n\nRequest.prototype.error = function (err) {\n  if (!this.fired) {\n    debug('request error', err, this.id, this.question);\n    this.emit('error', err);\n    this.done();\n  }\n};\n\nRequest.prototype.send = function () {\n  debug('request starting', this.question);\n  var self = this;\n\n  if (this.cache && this.cache.lookup) {\n    this.cache.lookup(this.question, function (results) {\n      var packet;\n\n      if (!results) {\n        self._send();\n      } else {\n        packet = new Packet();\n        packet.answer = results.slice();\n        self.handle(null, packet, true);\n      }\n    });\n  } else {\n    this._send();\n  }\n};\n\nRequest.prototype._send = function () {\n  debug('request not in cache', this.question);\n  var self = this;\n  this.timer_ = setTimeout(function () {\n    self.handleTimeout();\n  }, this.timeout);\n  PendingRequests.send(self);\n};\n\nRequest.prototype.cancel = function () {\n  debug('request cancelled', this.id, this.question);\n  this.emit('cancelled');\n  this.done();\n};\n\nvar _queue = [];\n\nvar sendQueued = function () {\n  debug('platform ready sending queued requests');\n\n  _queue.forEach(function (request) {\n    request.start();\n  });\n\n  _queue = [];\n};\n\nplatform.on('ready', function () {\n  sendQueued();\n});\n\nif (platform.ready) {\n  sendQueued();\n}\n\nvar Resolve = function Resolve(opts, cb) {\n  if (!(this instanceof Resolve)) return new Resolve(opts, cb);\n  this.opts = util._extend({\n    retryOnTruncate: true\n  }, opts);\n  this._domain = opts.domain;\n  this._rrtype = opts.rrtype;\n\n  this._buildQuestion(this._domain);\n\n  this._started = false;\n  this._current_server = undefined;\n  this._server_list = [];\n\n  if (opts.remote) {\n    this._server_list.push({\n      address: opts.remote,\n      port: 53,\n      type: 'tcp'\n    });\n\n    this._server_list.push({\n      address: opts.remote,\n      port: 53,\n      type: 'udp'\n    });\n  }\n\n  this._request = undefined;\n  this._type = 'getHostByName';\n  this._cb = cb;\n\n  if (!platform.ready) {\n    _queue.push(this);\n  } else {\n    this.start();\n  }\n};\n\nutil.inherits(Resolve, EventEmitter);\n\nResolve.prototype.cancel = function () {\n  if (this._request) {\n    this._request.cancel();\n  }\n};\n\nResolve.prototype._buildQuestion = function (name) {\n  debug('building question', name);\n  this.question = {\n    type: this._rrtype,\n    class: consts.NAME_TO_QCLASS.IN,\n    name: name\n  };\n};\n\nexports.Resolve = Resolve;\n\nResolve.prototype._emit = function (err, answer) {\n  debug('resolve end', this._domain);\n  var self = this;\n  process.nextTick(function () {\n    if (err) {\n      err.syscall = self._type;\n    }\n\n    self._cb(err, answer);\n  });\n};\n\nResolve.prototype._fillServers = function () {\n  debug('resolve filling servers', this._domain);\n  var tries = 0,\n      s,\n      t,\n      u,\n      slist;\n  slist = platform.name_servers;\n\n  while (this._server_list.length < platform.attempts) {\n    s = slist[tries % slist.length];\n    u = {\n      address: s.address,\n      port: s.port,\n      type: 'udp'\n    };\n    t = {\n      address: s.address,\n      port: s.port,\n      type: 'tcp'\n    };\n\n    this._server_list.push(u);\n\n    this._server_list.push(t);\n\n    tries += 1;\n  }\n\n  this._server_list.reverse();\n};\n\nResolve.prototype._popServer = function () {\n  debug('resolve pop server', this._current_server, this._domain);\n\n  this._server_list.splice(0, 1, this._current_server);\n};\n\nResolve.prototype._preStart = function () {\n  if (!this._started) {\n    this._started = new Date().getTime();\n    this.try_edns = platform.edns;\n    if (!this._server_list.length) this._fillServers();\n  }\n};\n\nResolve.prototype._shouldContinue = function () {\n  debug('resolve should continue', this._server_list.length, this._domain);\n  return this._server_list.length;\n};\n\nResolve.prototype._nextQuestion = function () {\n  debug('resolve next question', this._domain);\n};\n\nResolve.prototype.start = function () {\n  if (!this._started) {\n    this._preStart();\n  }\n\n  if (this._server_list.length === 0) {\n    debug('resolve no more servers', this._domain);\n    this.handleTimeout();\n  } else {\n    this._current_server = this._server_list.pop();\n    debug('resolve start', this._current_server, this._domain);\n    this._request = Request({\n      question: this.question,\n      server: this._current_server,\n      timeout: platform.timeout,\n      try_edns: this.try_edns\n    });\n\n    this._request.on('timeout', this._handleTimeout.bind(this));\n\n    this._request.on('message', this._handle.bind(this));\n\n    this._request.on('error', this._handle.bind(this));\n\n    this._request.send();\n  }\n};\n\nvar NOERROR = consts.NAME_TO_RCODE.NOERROR,\n    SERVFAIL = consts.NAME_TO_RCODE.SERVFAIL,\n    NOTFOUND = consts.NAME_TO_RCODE.NOTFOUND,\n    FORMERR = consts.NAME_TO_RCODE.FORMERR;\n\nResolve.prototype._handle = function (err, answer) {\n  var rcode, errno;\n\n  if (answer) {\n    rcode = answer.header.rcode;\n  }\n\n  debug('resolve handle', rcode, this._domain);\n\n  switch (rcode) {\n    case NOERROR:\n      // answer trucated retry with tcp\n      //console.log(answer);\n      if (answer.header.tc && this.opts.retryOnTruncate && this._shouldContinue()) {\n        debug('truncated', this._domain, answer);\n        this.emit('truncated', err, answer); // remove udp servers\n\n        this._server_list = this._server_list.filter(function (server) {\n          return server.type === 'tcp';\n        });\n        answer = undefined;\n      }\n\n      break;\n\n    case SERVFAIL:\n      if (this._shouldContinue()) {\n        this._nextQuestion(); //this._popServer();\n\n      } else {\n        errno = consts.SERVFAIL;\n      }\n\n      answer = undefined;\n      break;\n\n    case NOTFOUND:\n      if (this._shouldContinue()) {\n        this._nextQuestion();\n      } else {\n        errno = consts.NOTFOUND;\n      }\n\n      answer = undefined;\n      break;\n\n    case FORMERR:\n      if (this.try_edns) {\n        this.try_edns = false; //this._popServer();\n      } else {\n        errno = consts.FORMERR;\n      }\n\n      answer = undefined;\n      break;\n\n    default:\n      if (!err) {\n        errno = consts.RCODE_TO_NAME[rcode];\n        answer = undefined;\n      } else {\n        errno = consts.NOTFOUND;\n      }\n\n      break;\n  }\n\n  if (errno || answer) {\n    if (errno) {\n      err = new Error(this._type + ' ' + errno);\n      err.errno = err.code = errno;\n    }\n\n    this._emit(err, answer);\n  } else {\n    this.start();\n  }\n};\n\nResolve.prototype._handleTimeout = function () {\n  var err;\n\n  if (this._server_list.length === 0) {\n    debug('resolve timeout no more servers', this._domain);\n    err = new Error(this._type + ' ' + consts.TIMEOUT);\n    err.errno = consts.TIMEOUT;\n\n    this._emit(err, undefined);\n  } else {\n    debug('resolve timeout continue', this._domain);\n    this.start();\n  }\n};\n\nvar resolve = function (domain, rrtype, ip, callback) {\n  var res;\n\n  if (!callback) {\n    callback = ip;\n    ip = undefined;\n  }\n\n  if (!callback) {\n    callback = rrtype;\n    rrtype = undefined;\n  }\n\n  rrtype = consts.NAME_TO_QTYPE[rrtype || 'A'];\n\n  if (rrtype === PTR) {\n    return reverse(domain, callback);\n  }\n\n  var opts = {\n    domain: domain,\n    rrtype: rrtype,\n    remote: ip\n  };\n  res = new Resolve(opts);\n\n  res._cb = function (err, response) {\n    var ret = [],\n        i,\n        a;\n\n    if (err) {\n      callback(err, response);\n      return;\n    }\n\n    for (i = 0; i < response.answer.length; i++) {\n      a = response.answer[i];\n\n      if (a.type === rrtype) {\n        switch (rrtype) {\n          case A:\n          case AAAA:\n            ret.push(a.address);\n            break;\n\n          case consts.NAME_TO_QTYPE.MX:\n            ret.push({\n              priority: a.priority,\n              exchange: a.exchange\n            });\n            break;\n\n          case TXT:\n          case NS:\n          case CNAME:\n          case PTR:\n            ret.push(a.data);\n            break;\n\n          case SRV:\n            ret.push({\n              priority: a.priority,\n              weight: a.weight,\n              port: a.port,\n              name: a.target\n            });\n            break;\n\n          default:\n            ret.push(a);\n            break;\n        }\n      }\n    }\n\n    if (ret.length === 0) {\n      ret = undefined;\n    }\n\n    callback(err, ret);\n  };\n\n  return res;\n};\n\nexports.resolve = resolve;\n\nvar resolve4 = function (domain, callback) {\n  return resolve(domain, 'A', function (err, results) {\n    callback(err, results);\n  });\n};\n\nexports.resolve4 = resolve4;\n\nvar resolve6 = function (domain, callback) {\n  return resolve(domain, 'AAAA', function (err, results) {\n    callback(err, results);\n  });\n};\n\nexports.resolve6 = resolve6;\n\nvar resolveMx = function (domain, callback) {\n  return resolve(domain, 'MX', function (err, results) {\n    callback(err, results);\n  });\n};\n\nexports.resolveMx = resolveMx;\n\nvar resolveTxt = function (domain, callback) {\n  return resolve(domain, 'TXT', function (err, results) {\n    callback(err, results);\n  });\n};\n\nexports.resolveTxt = resolveTxt;\n\nvar resolveSrv = function (domain, callback) {\n  return resolve(domain, 'SRV', function (err, results) {\n    callback(err, results);\n  });\n};\n\nexports.resolveSrv = resolveSrv;\n\nvar resolveNs = function (domain, callback) {\n  return resolve(domain, 'NS', function (err, results) {\n    callback(err, results);\n  });\n};\n\nexports.resolveNs = resolveNs;\n\nvar resolveCname = function (domain, callback) {\n  return resolve(domain, 'CNAME', function (err, results) {\n    callback(err, results);\n  });\n};\n\nexports.resolveCname = resolveCname;\n\nvar reverse = function (ip, callback) {\n  var error, opts, res;\n\n  if (!net.isIP(ip)) {\n    error = new Error('getHostByAddr ENOTIMP');\n    error.errno = error.code = 'ENOTIMP';\n    throw error;\n  }\n\n  opts = {\n    domain: utils.reverseIP(ip),\n    rrtype: PTR\n  };\n  res = new Lookup(opts);\n\n  res._cb = function (err, response) {\n    var results = [];\n\n    if (response) {\n      response.answer.forEach(function (a) {\n        if (a.type === PTR) {\n          results.push(a.data);\n        }\n      });\n    }\n\n    if (results.length === 0) {\n      results = undefined;\n    }\n\n    callback(err, results);\n  };\n\n  return res;\n};\n\nexports.reverse = reverse;\n\nvar Lookup = function (opts) {\n  Resolve.call(this, opts);\n  this._type = 'getaddrinfo';\n};\n\nutil.inherits(Lookup, Resolve);\n\nLookup.prototype.start = function () {\n  var self = this;\n\n  if (!this._started) {\n    this._search_path = platform.search_path.slice(0);\n\n    this._preStart();\n  }\n\n  platform.hosts.lookup(this.question, function (results) {\n    var packet;\n\n    if (results && results.length) {\n      debug('Lookup in hosts', results);\n      packet = new Packet();\n      packet.answer = results.slice();\n\n      self._emit(null, packet);\n    } else {\n      debug('Lookup not in hosts');\n      Resolve.prototype.start.call(self);\n    }\n  });\n};\n\nLookup.prototype._shouldContinue = function () {\n  debug('Lookup should continue', this._server_list.length, this._search_path.length);\n  return this._server_list.length && this._search_path.length;\n};\n\nLookup.prototype._nextQuestion = function () {\n  debug('Lookup next question');\n\n  this._buildQuestion([this._domain, this._search_path.pop()].join('.'));\n};\n\nvar lookup = function (domain, family, callback) {\n  var rrtype, revip, res;\n\n  if (!callback) {\n    callback = family;\n    family = undefined;\n  }\n\n  if (!family) {\n    family = 4;\n  }\n\n  revip = net.isIP(domain);\n\n  if (revip === 4 || revip === 6) {\n    process.nextTick(function () {\n      callback(null, domain, revip);\n    });\n    return {};\n  }\n\n  if (!domain) {\n    process.nextTick(function () {\n      callback(null, null, family);\n    });\n    return {};\n  }\n\n  rrtype = consts.FAMILY_TO_QTYPE[family];\n  var opts = {\n    domain: domain,\n    rrtype: rrtype\n  };\n  res = new Lookup(opts);\n\n  res._cb = function (err, response) {\n    var i, afamily, address, a, all;\n\n    if (err) {\n      callback(err, undefined, undefined);\n      return;\n    }\n\n    all = response.answer.concat(response.additional);\n\n    for (i = 0; i < all.length; i++) {\n      a = all[i];\n\n      if (a.type === A || a.type === AAAA) {\n        afamily = consts.QTYPE_TO_FAMILY[a.type];\n        address = a.address;\n        break;\n      }\n    }\n\n    callback(err, address, afamily);\n  };\n\n  return res;\n};\n\nexports.lookup = lookup;","map":{"version":3,"sources":["C:/react/quiz/node_modules/native-dns/lib/client.js"],"names":["ipaddr","require","net","util","EventEmitter","PendingRequests","Packet","consts","utils","platform","A","NAME_TO_QTYPE","AAAA","MX","TXT","NS","CNAME","SRV","PTR","debug","process","env","NODE_DEBUG","match","args","Array","prototype","slice","call","arguments","console","error","apply","Date","now","toString","concat","Request","exports","opts","question","server","String","address","port","type","isIP","Error","indexOf","timeout","try_edns","fired","id","undefined","cache","inherits","handle","err","answer","cached","store","emit","done","clearTimeout","timer_","remove","handleTimeout","send","self","lookup","results","packet","_send","setTimeout","cancel","_queue","sendQueued","forEach","request","start","on","ready","Resolve","cb","_extend","retryOnTruncate","_domain","domain","_rrtype","rrtype","_buildQuestion","_started","_current_server","_server_list","remote","push","_request","_type","_cb","name","class","NAME_TO_QCLASS","IN","_emit","nextTick","syscall","_fillServers","tries","s","t","u","slist","name_servers","length","attempts","reverse","_popServer","splice","_preStart","getTime","edns","_shouldContinue","_nextQuestion","pop","_handleTimeout","bind","_handle","NOERROR","NAME_TO_RCODE","SERVFAIL","NOTFOUND","FORMERR","rcode","errno","header","tc","filter","RCODE_TO_NAME","code","TIMEOUT","resolve","ip","callback","res","response","ret","i","a","priority","exchange","data","weight","target","resolve4","resolve6","resolveMx","resolveTxt","resolveSrv","resolveNs","resolveCname","reverseIP","Lookup","_search_path","search_path","hosts","join","family","revip","FAMILY_TO_QTYPE","afamily","all","additional","QTYPE_TO_FAMILY"],"mappings":"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","sourcesContent":["// Copyright 2011 Timothy J Fontaine <tjfontaine@gmail.com>\n//\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n//\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n// THE SOFTWARE\n\n'use strict';\n\nvar ipaddr = require('ipaddr.js'),\n    net = require('net'),\n    util = require('util'),\n    EventEmitter = require('events').EventEmitter,\n    PendingRequests = require('./pending'),\n    Packet = require('./packet'),\n    consts = require('native-dns-packet').consts,\n    utils = require('./utils'),\n    platform = require('./platform');\n\nvar A = consts.NAME_TO_QTYPE.A,\n    AAAA = consts.NAME_TO_QTYPE.AAAA,\n    MX = consts.NAME_TO_QTYPE.MX,\n    TXT = consts.NAME_TO_QTYPE.TXT,\n    NS = consts.NAME_TO_QTYPE.NS,\n    CNAME = consts.NAME_TO_QTYPE.CNAME,\n    SRV = consts.NAME_TO_QTYPE.SRV,\n    PTR = consts.NAME_TO_QTYPE.PTR;\n\nvar debug = function() {};\n\nif (process.env.NODE_DEBUG && process.env.NODE_DEBUG.match(/dns/)) {\ndebug = function debug() {\n  var args = Array.prototype.slice.call(arguments);\n  console.error.apply(this, ['client', Date.now().toString()].concat(args));\n};\n}\n\nvar Request = exports.Request = function(opts) {\n  if (!(this instanceof Request)) return new Request(opts);\n\n  this.question = opts.question;\n  this.server = opts.server;\n\n  if (typeof(this.server) === 'string' || this.server instanceof String)\n    this.server = { address: this.server, port: 53, type: 'udp'};\n\n  if (!this.server || !this.server.address || !net.isIP(this.server.address))\n    throw new Error('Server object must be supplied with at least address');\n\n  if (!this.server.type || ['udp', 'tcp'].indexOf(this.server.type) === -1)\n    this.server.type = 'udp';\n\n  if (!this.server.port)\n    this.server.port = 53;\n\n  this.timeout = opts.timeout || 4 * 1000;\n  this.try_edns = opts.try_edns || false;\n\n  this.fired = false;\n  this.id = undefined;\n\n  if (opts.cache || opts.cache === false) {\n    this.cache = opts.cache;\n  } else {\n    this.cache = platform.cache;\n  }\n  debug('request created', this.question);\n};\nutil.inherits(Request, EventEmitter);\n\nRequest.prototype.handle = function(err, answer, cached) {\n  if (!this.fired) {\n    debug('request handled', this.id, this.question);\n\n    if (!cached && this.cache && this.cache.store && answer) {\n      this.cache.store(answer);\n    }\n\n    this.emit('message', err, answer);\n    this.done();\n  }\n};\n\nRequest.prototype.done = function() {\n  debug('request finished', this.id, this.question);\n  this.fired = true;\n  clearTimeout(this.timer_);\n  PendingRequests.remove(this);\n  this.emit('end');\n  this.id = undefined;\n};\n\nRequest.prototype.handleTimeout = function() {\n  if (!this.fired) {\n    debug('request timedout', this.id, this.question);\n    this.emit('timeout');\n    this.done();\n  }\n};\n\nRequest.prototype.error = function(err) {\n  if (!this.fired) {\n    debug('request error', err, this.id, this.question);\n    this.emit('error', err);\n    this.done();\n  }\n};\n\nRequest.prototype.send = function() {\n  debug('request starting', this.question);\n  var self = this;\n\n  if (this.cache && this.cache.lookup) {\n    this.cache.lookup(this.question, function(results) {\n      var packet;\n\n      if (!results) {\n        self._send();\n      } else {\n        packet = new Packet();\n        packet.answer = results.slice();\n        self.handle(null, packet, true);\n      }\n    });\n  } else {\n    this._send();\n  }\n};\n\nRequest.prototype._send = function() {\n  debug('request not in cache', this.question);\n  var self = this;\n\n  this.timer_ = setTimeout(function() {\n    self.handleTimeout();\n  }, this.timeout);\n\n  PendingRequests.send(self);\n};\n\nRequest.prototype.cancel = function() {\n  debug('request cancelled', this.id, this.question);\n  this.emit('cancelled');\n  this.done();\n};\n\nvar _queue = [];\n\nvar sendQueued = function() {\n  debug('platform ready sending queued requests');\n  _queue.forEach(function(request) {\n    request.start();\n  });\n  _queue = [];\n};\n\nplatform.on('ready', function() {\n  sendQueued();\n});\n\nif (platform.ready) {\n  sendQueued();\n}\n\nvar Resolve = function Resolve(opts, cb) {\n  if (!(this instanceof Resolve)) return new Resolve(opts, cb);\n\n  this.opts = util._extend({\n    retryOnTruncate: true,\n  }, opts);\n\n  this._domain = opts.domain;\n  this._rrtype = opts.rrtype;\n\n  this._buildQuestion(this._domain);\n\n  this._started = false;\n  this._current_server = undefined;\n\n  this._server_list = [];\n\n  if (opts.remote) {\n    this._server_list.push({\n      address: opts.remote,\n      port: 53,\n      type: 'tcp',\n    });\n    this._server_list.push({\n      address: opts.remote,\n      port: 53,\n      type: 'udp',\n    });\n  }\n\n  this._request = undefined;\n  this._type = 'getHostByName';\n  this._cb = cb;\n\n  if (!platform.ready) {\n    _queue.push(this);\n  } else {\n    this.start();\n  }\n};\nutil.inherits(Resolve, EventEmitter);\n\nResolve.prototype.cancel = function() {\n  if (this._request) {\n    this._request.cancel();\n  }\n};\n\nResolve.prototype._buildQuestion = function(name) {\n  debug('building question', name);\n  this.question = {\n    type: this._rrtype,\n    class: consts.NAME_TO_QCLASS.IN,\n    name: name\n  };\n};\nexports.Resolve = Resolve;\n\nResolve.prototype._emit = function(err, answer) {\n  debug('resolve end', this._domain);\n  var self = this;\n  process.nextTick(function() {\n    if (err) {\n      err.syscall = self._type;\n    }\n    self._cb(err, answer);\n  });\n};\n\nResolve.prototype._fillServers = function() {\n  debug('resolve filling servers', this._domain);\n  var tries = 0, s, t, u, slist;\n\n  slist = platform.name_servers;\n\n  while (this._server_list.length < platform.attempts) {\n    s = slist[tries % slist.length];\n\n    u = {\n      address: s.address,\n      port: s.port,\n      type: 'udp'\n    };\n\n    t = {\n      address: s.address,\n      port: s.port,\n      type: 'tcp'\n    };\n\n    this._server_list.push(u);\n    this._server_list.push(t);\n\n    tries += 1;\n  }\n\n  this._server_list.reverse();\n};\n\nResolve.prototype._popServer = function() {\n  debug('resolve pop server', this._current_server, this._domain);\n  this._server_list.splice(0, 1, this._current_server);\n};\n\nResolve.prototype._preStart = function() {\n  if (!this._started) {\n    this._started = new Date().getTime();\n    this.try_edns = platform.edns;\n\n    if (!this._server_list.length)\n      this._fillServers();\n  }\n};\n\nResolve.prototype._shouldContinue = function() {\n  debug('resolve should continue', this._server_list.length, this._domain);\n  return this._server_list.length;\n};\n\nResolve.prototype._nextQuestion = function() {\n  debug('resolve next question', this._domain);\n};\n\nResolve.prototype.start = function() {\n  if (!this._started) {\n    this._preStart();\n  }\n\n  if (this._server_list.length === 0) {\n    debug('resolve no more servers', this._domain);\n    this.handleTimeout();\n  } else {\n    this._current_server = this._server_list.pop();\n    debug('resolve start', this._current_server, this._domain);\n\n    this._request = Request({\n      question: this.question,\n      server: this._current_server,\n      timeout: platform.timeout,\n      try_edns: this.try_edns\n    });\n\n    this._request.on('timeout', this._handleTimeout.bind(this));\n    this._request.on('message', this._handle.bind(this));\n    this._request.on('error', this._handle.bind(this));\n\n    this._request.send();\n  }\n};\n\nvar NOERROR = consts.NAME_TO_RCODE.NOERROR,\n    SERVFAIL = consts.NAME_TO_RCODE.SERVFAIL,\n    NOTFOUND = consts.NAME_TO_RCODE.NOTFOUND,\n    FORMERR = consts.NAME_TO_RCODE.FORMERR;\n\nResolve.prototype._handle = function(err, answer) {\n  var rcode, errno;\n\n  if (answer) {\n    rcode = answer.header.rcode;\n  }\n\n  debug('resolve handle', rcode, this._domain);\n\n  switch (rcode) {\n    case NOERROR:\n      // answer trucated retry with tcp\n      //console.log(answer);\n      if (answer.header.tc &&\n          this.opts.retryOnTruncate &&\n          this._shouldContinue()) {\n        debug('truncated', this._domain, answer);\n        this.emit('truncated', err, answer);\n        \n        // remove udp servers\n        this._server_list = this._server_list.filter(function(server) {\n          return server.type === 'tcp';\n        });\n        answer = undefined;\n      }\n      break;\n    case SERVFAIL:\n      if (this._shouldContinue()) {\n        this._nextQuestion();\n        //this._popServer();\n      } else {\n        errno = consts.SERVFAIL;\n      }\n      answer = undefined;\n      break;\n    case NOTFOUND:\n      if (this._shouldContinue()) {\n        this._nextQuestion();\n      } else {\n        errno = consts.NOTFOUND;\n      }\n      answer = undefined;\n      break;\n    case FORMERR:\n      if (this.try_edns) {\n        this.try_edns = false;\n        //this._popServer();\n      } else {\n        errno = consts.FORMERR;\n      }\n      answer = undefined;\n      break;\n    default:\n      if (!err) {\n        errno = consts.RCODE_TO_NAME[rcode];\n        answer = undefined;\n      } else {\n        errno = consts.NOTFOUND;\n      }\n      break;\n  }\n\n  if (errno || answer) {\n    if (errno) {\n      err = new Error(this._type + ' ' + errno);\n      err.errno = err.code = errno;\n    }\n    this._emit(err, answer);\n  } else {\n    this.start();\n  }\n};\n\nResolve.prototype._handleTimeout = function() {\n  var err;\n\n  if (this._server_list.length === 0) {\n    debug('resolve timeout no more servers', this._domain);\n    err = new Error(this._type + ' ' + consts.TIMEOUT);\n    err.errno = consts.TIMEOUT;\n    this._emit(err, undefined);\n  } else {\n    debug('resolve timeout continue', this._domain);\n    this.start();\n  }\n};\n\nvar resolve = function(domain, rrtype, ip, callback) {\n  var res;\n\n  if (!callback) {\n    callback = ip;\n    ip = undefined;\n  }\n\n  if (!callback) {\n    callback = rrtype;\n    rrtype = undefined;\n  }\n\n  rrtype = consts.NAME_TO_QTYPE[rrtype || 'A'];\n\n  if (rrtype === PTR) {\n    return reverse(domain, callback);\n  }\n\n  var opts = {\n    domain: domain,\n    rrtype: rrtype,\n    remote: ip,\n  };\n\n  res = new Resolve(opts);\n\n  res._cb = function(err, response) {\n    var ret = [], i, a;\n\n    if (err) {\n      callback(err, response);\n      return;\n    }\n\n    for (i = 0; i < response.answer.length; i++) {\n      a = response.answer[i];\n      if (a.type === rrtype) {\n        switch (rrtype) {\n          case A:\n          case AAAA:\n            ret.push(a.address);\n            break;\n          case consts.NAME_TO_QTYPE.MX:\n            ret.push({\n              priority: a.priority,\n              exchange: a.exchange\n            });\n            break;\n          case TXT:\n          case NS:\n          case CNAME:\n          case PTR:\n            ret.push(a.data);\n            break;\n          case SRV:\n            ret.push({\n              priority: a.priority,\n              weight: a.weight,\n              port: a.port,\n              name: a.target\n            });\n            break;\n          default:\n            ret.push(a);\n            break;\n        }\n      }\n    }\n\n    if (ret.length === 0) {\n      ret = undefined;\n    }\n\n    callback(err, ret);\n  };\n\n  return res;\n};\nexports.resolve = resolve;\n\nvar resolve4 = function(domain, callback) {\n  return resolve(domain, 'A', function(err, results) {\n    callback(err, results);\n  });\n};\nexports.resolve4 = resolve4;\n\nvar resolve6 = function(domain, callback) {\n  return resolve(domain, 'AAAA', function(err, results) {\n    callback(err, results);\n  });\n};\nexports.resolve6 = resolve6;\n\nvar resolveMx = function(domain, callback) {\n  return resolve(domain, 'MX', function(err, results) {\n    callback(err, results);\n  });\n};\nexports.resolveMx = resolveMx;\n\nvar resolveTxt = function(domain, callback) {\n  return resolve(domain, 'TXT', function(err, results) {\n    callback(err, results);\n  });\n};\nexports.resolveTxt = resolveTxt;\n\nvar resolveSrv = function(domain, callback) {\n  return resolve(domain, 'SRV', function(err, results) {\n    callback(err, results);\n  });\n};\nexports.resolveSrv = resolveSrv;\n\nvar resolveNs = function(domain, callback) {\n  return resolve(domain, 'NS', function(err, results) {\n    callback(err, results);\n  });\n};\nexports.resolveNs = resolveNs;\n\nvar resolveCname = function(domain, callback) {\n  return resolve(domain, 'CNAME', function(err, results) {\n    callback(err, results);\n  });\n};\nexports.resolveCname = resolveCname;\n\nvar reverse = function(ip, callback) {\n  var error, opts, res;\n\n  if (!net.isIP(ip)) {\n    error = new Error('getHostByAddr ENOTIMP');\n    error.errno = error.code = 'ENOTIMP';\n    throw error;\n  }\n\n  opts = {\n    domain: utils.reverseIP(ip),\n    rrtype: PTR\n  };\n\n  res = new Lookup(opts);\n\n  res._cb = function(err, response) {\n    var results = [];\n\n    if (response) {\n      response.answer.forEach(function(a) {\n        if (a.type === PTR) {\n          results.push(a.data);\n        }\n      });\n    }\n\n    if (results.length === 0) {\n      results = undefined;\n    }\n\n    callback(err, results);\n  };\n\n  return res;\n};\nexports.reverse = reverse;\n\nvar Lookup = function(opts) {\n  Resolve.call(this, opts);\n  this._type = 'getaddrinfo';\n};\nutil.inherits(Lookup, Resolve);\n\nLookup.prototype.start = function() {\n  var self = this;\n\n  if (!this._started) {\n    this._search_path = platform.search_path.slice(0);\n    this._preStart();\n  }\n\n  platform.hosts.lookup(this.question, function(results) {\n    var packet;\n    if (results && results.length) {\n      debug('Lookup in hosts', results);\n      packet = new Packet();\n      packet.answer = results.slice();\n      self._emit(null, packet);\n    } else {\n      debug('Lookup not in hosts');\n      Resolve.prototype.start.call(self);\n    }\n  });\n};\n\nLookup.prototype._shouldContinue = function() {\n  debug('Lookup should continue', this._server_list.length,\n        this._search_path.length);\n  return this._server_list.length && this._search_path.length;\n};\n\nLookup.prototype._nextQuestion = function() {\n  debug('Lookup next question');\n  this._buildQuestion([this._domain, this._search_path.pop()].join('.'));\n};\n\nvar lookup = function(domain, family, callback) {\n  var rrtype, revip, res;\n\n  if (!callback) {\n    callback = family;\n    family = undefined;\n  }\n\n  if (!family) {\n    family = 4;\n  }\n\n  revip = net.isIP(domain);\n\n  if (revip === 4 || revip === 6) {\n    process.nextTick(function() {\n      callback(null, domain, revip);\n    });\n    return {};\n  }\n\n  if (!domain) {\n    process.nextTick(function() {\n      callback(null, null, family);\n    });\n    return {};\n  }\n\n  rrtype = consts.FAMILY_TO_QTYPE[family];\n\n  var opts = {\n    domain: domain,\n    rrtype: rrtype\n  };\n\n  res = new Lookup(opts);\n\n  res._cb = function(err, response) {\n    var i, afamily, address, a, all;\n\n    if (err) {\n      callback(err, undefined, undefined);\n      return;\n    }\n\n    all = response.answer.concat(response.additional);\n\n    for (i = 0; i < all.length; i++) {\n      a = all[i];\n\n      if (a.type === A || a.type === AAAA) {\n        afamily = consts.QTYPE_TO_FAMILY[a.type];\n        address = a.address;\n        break;\n      }\n    }\n\n    callback(err, address, afamily);\n  };\n\n  return res;\n};\nexports.lookup = lookup;\n"]},"metadata":{},"sourceType":"script"}