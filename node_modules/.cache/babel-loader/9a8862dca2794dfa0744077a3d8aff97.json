{"ast":null,"code":"module.exports = function () {\n  var dnsd = require('hbo-dnsd'),\n      dns = require('native-dns');\n\n  function Dns(config) {\n    var $this = this;\n    this.config = {};\n    this.config.host = process.env.DNSINTERFACE || config.dns.host;\n    this.config.port = process.env.DNSPORT || config.dns.port;\n    this.config.zone = process.env.DNSZONE || config.dns.zone;\n    this.config.ttl = process.env.DNSTTL || config.dns.ttl;\n    this.config.prefix = process.env.DNSPREFIX || config.dns.prefix;\n    this.config.primary = process.env.DNSPRIMARY || config.dns.primary;\n    this.config.secondary = process.env.DNSSECONDARY || config.dns.secondary;\n    this.config.timeout = process.env.DNSTIMEOUT || config.dns.timeout;\n    this.store = config.store;\n    this.meta = config.meta;\n    this.logger = config.logger;\n    this.logger.log('debug', \"dns-config=%j\", this.config, this.meta);\n    this.logger.log('debug', \"env=%j\", process.env, this.meta);\n    this.logger.log('debug', \"store=%j\", config.store, this.meta);\n  }\n\n  Dns.prototype.nativeDNS = function (dnsAddress, question, hostname, req, res, next) {\n    var timedout = false;\n    var $this = this,\n        nativeQuestion = dns.Question({\n      name: question.name,\n      type: question.type\n    }),\n        nativeReq = dns.Request({\n      question: nativeQuestion,\n      server: {\n        address: dnsAddress,\n        port: 53,\n        type: 'udp'\n      },\n      timeout: $this.config.timeout\n    });\n    nativeReq.on('timeout', function () {\n      if (dnsAddress === $this.config.secondary) {\n        $this.logger.log('error', '%s:%s/%s - %s - %s question:\"%s\" - %j -- timeout', req.connection.remoteAddress, req.connection.remotePort, req.connection.type, dnsAddress, hostname, question, res.answer, $this.meta);\n        return next(new Error('DNS:nativeDNS:timeout: ' + $this.config.secondary));\n      }\n\n      $this.logger.log('warn', '%s:%s/%s - %s - %s question:\"%s\" - %j -- timeout', req.connection.remoteAddress, req.connection.remotePort, req.connection.type, dnsAddress, hostname, question, res.answer, $this.meta);\n      timedout = true;\n      $this.nativeDNS($this.config.secondary, question, hostname, req, res, next);\n    });\n    nativeReq.on('message', function (err, answer) {\n      answer.answer.forEach(function (oneAnswer) {\n        answer = {\n          name: hostname,\n          type: question.type,\n          class: question.class,\n          data: oneAnswer.address,\n          ttl: oneAnswer.ttl\n        };\n        res.answer.push(answer);\n      });\n    });\n    nativeReq.on('end', function () {\n      if (!timedout) {\n        $this.logger.log('info', '%s:%s/%s - %s - %s question:\"%s\" - %j', req.connection.remoteAddress, req.connection.remotePort, req.connection.type, dnsAddress, hostname, question, res.answer, $this.meta);\n        next(null);\n      }\n    });\n    nativeReq.send();\n  };\n\n  Dns.prototype.resolver = function (req, res) {\n    var $this = this,\n        question = res.question[0],\n        hostname = question.name,\n        length = hostname.length,\n        answer = {},\n        key = this.config.prefix + hostname;\n    this.store.get(key, function (err, value) {\n      $this.logger.log('debug', '%s:%s/%s - local - %s question:\"%s\" - store key[%s] value[%s] err[%j]', req.connection.remoteAddress, req.connection.remotePort, req.connection.type, hostname, question, key, value, err, $this.meta);\n      var object;\n\n      if (!err && value) {\n        try {\n          object = JSON.parse(value);\n          $this.logger.log('debug', '%s:%s/%s - local - %s question:\"%s\" - store key[%s] value[%s] == object[%j]', req.connection.remoteAddress, req.connection.remotePort, req.connection.type, hostname, question, key, value, object, $this.meta);\n        } catch (e) {\n          err = new Error(\"Exception [\" + util.inspect(e, true) + \"] while parsing store response [\" + value + \"]\");\n          $this.logger.log('error', '%s:%s/%s - local - %s question:\"%s\" - store key[%s] value[%s]', req.connection.remoteAddress, req.connection.remotePort, req.connection.type, hostname, question, key, value, $this.meta);\n        }\n      }\n\n      if (!err && object && object.hasOwnProperty(question.type)) {\n        answer = {\n          name: hostname,\n          type: question.type,\n          class: question.class,\n          ttl: $this.config.ttl\n        };\n\n        if (object[question.type]) {\n          var vector = object[question.type] instanceof Array ? object[question.type] : [object[question.type]];\n          vector.forEach(function (data) {\n            answer.data = '' + data;\n            res.answer.push(answer);\n            $this.logger.log('info', '%s:%s/%s - local - %s question:\"%s\" - %j', req.connection.remoteAddress, req.connection.remotePort, req.connection.type, hostname, question, answer, $this.meta);\n          });\n        } else {\n          res.answer.push(answer);\n          $this.logger.log('info', '%s:%s/%s - local - %s question:\"%s\" - %j', req.connection.remoteAddress, req.connection.remotePort, req.connection.type, hostname, question, answer, $this.meta);\n        }\n\n        return res.end();\n      } // Log the error and try with the external DNS\n\n\n      if (err) {\n        $this.logger.log('error', 'dns/local GET hostname \"%s\" - err=%j', hostname, err, $this.meta);\n      } // Send the requestion to the DNSPRIMARY and DNSSECONDARY\n\n\n      $this.nativeDNS($this.config.primary, question, hostname, req, res, function (err) {\n        if (err) {\n          $this.logger.log('error', '%s:%s/%s - local - %s question:\"%s\" - %j -- ERROR:%j', req.connection.remoteAddress, req.connection.remotePort, req.connection.type, hostname, question, res.answer, err, $this.meta);\n        }\n\n        res.end();\n      });\n    });\n  };\n\n  Dns.prototype.start = function () {\n    var $this = this;\n    this.server = dnsd.createServer(function (req, res) {\n      $this.resolver(req, res);\n    });\n    this.server.zone($this.config.zone, 'ns1.' + $this.config.zone, 'us@' + $this.config.zone, 'now', '2h', '30m', '2w', '10m').listen($this.config.port, $this.config.host);\n  };\n\n  function create(pkgConfig) {\n    return new Dns(pkgConfig);\n  }\n\n  return {\n    create: create\n  };\n}();","map":{"version":3,"sources":["C:/react/quiz/node_modules/dns/lib/dns.js"],"names":["module","exports","dnsd","require","dns","Dns","config","$this","host","process","env","DNSINTERFACE","port","DNSPORT","zone","DNSZONE","ttl","DNSTTL","prefix","DNSPREFIX","primary","DNSPRIMARY","secondary","DNSSECONDARY","timeout","DNSTIMEOUT","store","meta","logger","log","prototype","nativeDNS","dnsAddress","question","hostname","req","res","next","timedout","nativeQuestion","Question","name","type","nativeReq","Request","server","address","on","connection","remoteAddress","remotePort","answer","Error","err","forEach","oneAnswer","class","data","push","send","resolver","length","key","get","value","object","JSON","parse","e","util","inspect","hasOwnProperty","vector","Array","end","start","createServer","listen","create","pkgConfig"],"mappings":"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","sourcesContent":["module.exports = function () {\n    var dnsd   = require('hbo-dnsd'),\n        dns    = require('native-dns');\n\n    function Dns(config) {\n        var $this    = this;\n        this.config  = {};\n        this.config.host       = process.env.DNSINTERFACE             || config.dns.host;\n        this.config.port       = process.env.DNSPORT                  || config.dns.port;\n        this.config.zone       = process.env.DNSZONE                  || config.dns.zone;\n        this.config.ttl        = process.env.DNSTTL                   || config.dns.ttl;\n        this.config.prefix     = process.env.DNSPREFIX                || config.dns.prefix;\n        this.config.primary    = process.env.DNSPRIMARY               || config.dns.primary;\n        this.config.secondary  = process.env.DNSSECONDARY             || config.dns.secondary;\n        this.config.timeout    = process.env.DNSTIMEOUT               || config.dns.timeout;\n        this.store             = config.store;\n        this.meta              = config.meta;\n        this.logger            = config.logger;\n        this.logger.log('debug', \"dns-config=%j\", this.config, this.meta);\n        this.logger.log('debug', \"env=%j\", process.env, this.meta);\n        this.logger.log('debug', \"store=%j\", config.store, this.meta);\n    }\n\n    Dns.prototype.nativeDNS = function (dnsAddress, question, hostname, req, res, next) {\n        var timedout = false;\n        var $this = this,\n            nativeQuestion = dns.Question({\n                                name : question.name,\n                                type : question.type\n                             }),\n            nativeReq = dns.Request({\n                            question : nativeQuestion,\n                            server   : { \n                                address : dnsAddress, \n                                port    : 53, \n                                type    : 'udp'\n                            },\n                            timeout: $this.config.timeout\n                        });\n\n        nativeReq.on('timeout', function () {\n            if (dnsAddress === $this.config.secondary) {\n                $this.logger.log('error', '%s:%s/%s - %s - %s question:\"%s\" - %j -- timeout', req.connection.remoteAddress, req.connection.remotePort, req.connection.type, dnsAddress, hostname, question, res.answer, $this.meta);\n                return next(new Error('DNS:nativeDNS:timeout: ' + $this.config.secondary));\n            }\n            $this.logger.log('warn', '%s:%s/%s - %s - %s question:\"%s\" - %j -- timeout', req.connection.remoteAddress, req.connection.remotePort, req.connection.type, dnsAddress, hostname, question, res.answer, $this.meta);\n            timedout = true;\n            $this.nativeDNS($this.config.secondary, question, hostname, req, res, next);\n        });\n\n        nativeReq.on('message', function (err, answer) {\n            answer.answer.forEach(function (oneAnswer) {\n                answer = {\n                    name : hostname,\n                    type : question.type,\n                    class: question.class,\n                    data : oneAnswer.address,\n                    ttl  : oneAnswer.ttl\n                };\n                res.answer.push(answer);\n            });\n        });\n\n        nativeReq.on('end', function () {\n            if (!timedout) {\n                $this.logger.log('info', '%s:%s/%s - %s - %s question:\"%s\" - %j', req.connection.remoteAddress, req.connection.remotePort, req.connection.type, dnsAddress, hostname, question, res.answer, $this.meta);\n                next(null);\n            }\n        });\n\n        nativeReq.send();\n    };\n\n    Dns.prototype.resolver = function(req, res) {\n        var $this        = this,\n            question     = res.question[0], \n            hostname     = question.name, \n            length       = hostname.length, \n            answer       = {},\n            key          = this.config.prefix + hostname;\n\n        this.store.get(key, function (err, value) {\n            $this.logger.log('debug', '%s:%s/%s - local - %s question:\"%s\" - store key[%s] value[%s] err[%j]', req.connection.remoteAddress, req.connection.remotePort, req.connection.type, hostname, question, key, value, err, $this.meta);\n            var object;\n\n            if (!err && value) {\n                try {\n                    object = JSON.parse(value);\n                    $this.logger.log('debug', '%s:%s/%s - local - %s question:\"%s\" - store key[%s] value[%s] == object[%j]', req.connection.remoteAddress, req.connection.remotePort, req.connection.type, hostname, question, key, value, object, $this.meta);\n                } catch (e) {\n                    err = new Error(\"Exception [\" + util.inspect(e, true) + \"] while parsing store response [\" + value + \"]\");\n                    $this.logger.log('error', '%s:%s/%s - local - %s question:\"%s\" - store key[%s] value[%s]', req.connection.remoteAddress, req.connection.remotePort, req.connection.type, hostname, question, key, value, $this.meta);\n                }\n            }\n            if (!err && object && object.hasOwnProperty(question.type)) {\n                answer = {\n                    name: hostname,\n                    type: question.type,\n                    class: question.class,\n                    ttl: $this.config.ttl\n                };\n                if (object[question.type]) {\n                    var vector = object[question.type] instanceof Array ? object[question.type] : [object[question.type]];\n                    vector.forEach(function(data) {\n                        answer.data = ''+data;\n                        res.answer.push(answer);\n                        $this.logger.log('info', '%s:%s/%s - local - %s question:\"%s\" - %j', req.connection.remoteAddress, req.connection.remotePort, req.connection.type, hostname, question, answer, $this.meta);\n                    });\n                } else {\n                    res.answer.push(answer);\n                    $this.logger.log('info', '%s:%s/%s - local - %s question:\"%s\" - %j', req.connection.remoteAddress, req.connection.remotePort, req.connection.type, hostname, question, answer, $this.meta);\n                }\n                return res.end();\n            }\n            // Log the error and try with the external DNS\n            if (err) {\n                $this.logger.log('error', 'dns/local GET hostname \"%s\" - err=%j', hostname, err, $this.meta);\n            }\n            // Send the requestion to the DNSPRIMARY and DNSSECONDARY\n            $this.nativeDNS($this.config.primary, question, hostname, req, res, function (err) {\n                if (err) {\n                    $this.logger.log('error', '%s:%s/%s - local - %s question:\"%s\" - %j -- ERROR:%j', req.connection.remoteAddress, req.connection.remotePort, req.connection.type, hostname, question, res.answer, err, $this.meta);\n                }\n                res.end();\n            });\n        });\n    };\n\n    Dns.prototype.start = function() {\n        var $this = this;\n        this.server = dnsd.createServer(function (req, res) {\n            $this.resolver(req, res);\n        });\n\n        this.server.zone($this.config.zone, \n                         'ns1.'+$this.config.zone, \n                         'us@'+$this.config.zone, \n                         'now', '2h', '30m', '2w', '10m'\n                        ).listen($this.config.port, $this.config.host);\n    };\n\n    function create(pkgConfig) {\n        return new Dns(pkgConfig);\n    }\n\n    return {\n        create : create\n    };\n}();\n"]},"metadata":{},"sourceType":"script"}