{"ast":null,"code":"// Load modules\nvar Dgram = require('dgram');\n\nvar Dns = require('dns');\n\nvar Hoek = require('hoek'); // Declare internals\n\n\nvar internals = {};\n\nexports.time = function (options, callback) {\n  if (arguments.length !== 2) {\n    callback = arguments[0];\n    options = {};\n  }\n\n  var settings = Hoek.clone(options);\n  settings.host = settings.host || 'pool.ntp.org';\n  settings.port = settings.port || 123;\n  settings.resolveReference = settings.resolveReference || false; // Declare variables used by callback\n\n  var timeoutId = 0;\n  var sent = 0; // Ensure callback is only called once\n\n  var isFinished = false;\n\n  var finish = function (err, result) {\n    if (timeoutId) {\n      clearTimeout(timeoutId);\n      timeoutId = 0;\n    }\n\n    if (!isFinished) {\n      isFinished = true;\n      socket.close();\n      return callback(err, result);\n    }\n  }; // Create UDP socket\n\n\n  var socket = Dgram.createSocket('udp4');\n  socket.on('error', function (err) {\n    return finish(err);\n  }); // Listen to incoming messages\n\n  socket.on('message', function (buffer, rinfo) {\n    var received = Date.now();\n    var message = new internals.NtpMessage(buffer);\n\n    if (!message.isValid) {\n      return finish(new Error('Invalid server response'), message);\n    }\n\n    if (message.originateTimestamp !== sent) {\n      return finish(new Error('Wrong originate timestamp'), message);\n    } // Timestamp Name          ID   When Generated\n    // ------------------------------------------------------------\n    // Originate Timestamp     T1   time request sent by client\n    // Receive Timestamp       T2   time request received by server\n    // Transmit Timestamp      T3   time reply sent by server\n    // Destination Timestamp   T4   time reply received by client\n    //\n    // The roundtrip delay d and system clock offset t are defined as:\n    //\n    // d = (T4 - T1) - (T3 - T2)     t = ((T2 - T1) + (T3 - T4)) / 2\n\n\n    var T1 = message.originateTimestamp;\n    var T2 = message.receiveTimestamp;\n    var T3 = message.transmitTimestamp;\n    var T4 = received;\n    message.d = T4 - T1 - (T3 - T2);\n    message.t = (T2 - T1 + (T3 - T4)) / 2;\n    message.receivedLocally = received;\n\n    if (!settings.resolveReference || message.stratum !== 'secondary') {\n      return finish(null, message);\n    } // Resolve reference IP address\n\n\n    Dns.reverse(message.referenceId, function (err, domains) {\n      if (!err) {\n        message.referenceHost = domains[0];\n      }\n\n      return finish(null, message);\n    });\n  }); // Set timeout\n\n  if (settings.timeout) {\n    timeoutId = setTimeout(function () {\n      timeoutId = 0;\n      return finish(new Error('Timeout'));\n    }, settings.timeout);\n  } // Construct NTP message\n\n\n  var message = new Buffer(48);\n\n  for (var i = 0; i < 48; i++) {\n    // Zero message\n    message[i] = 0;\n  }\n\n  message[0] = (0 << 6) + (4 << 3) + (3 << 0); // Set version number to 4 and Mode to 3 (client)\n\n  sent = Date.now();\n  internals.fromMsecs(sent, message, 40); // Set transmit timestamp (returns as originate)\n  // Send NTP request\n\n  socket.send(message, 0, message.length, settings.port, settings.host, function (err, bytes) {\n    if (err || bytes !== 48) {\n      return finish(err || new Error('Could not send entire message'));\n    }\n  });\n};\n\ninternals.NtpMessage = function (buffer) {\n  this.isValid = false; // Validate\n\n  if (buffer.length !== 48) {\n    return;\n  } // Leap indicator\n\n\n  var li = buffer[0] >> 6;\n\n  switch (li) {\n    case 0:\n      this.leapIndicator = 'no-warning';\n      break;\n\n    case 1:\n      this.leapIndicator = 'last-minute-61';\n      break;\n\n    case 2:\n      this.leapIndicator = 'last-minute-59';\n      break;\n\n    case 3:\n      this.leapIndicator = 'alarm';\n      break;\n  } // Version\n\n\n  var vn = (buffer[0] & 0x38) >> 3;\n  this.version = vn; // Mode\n\n  var mode = buffer[0] & 0x7;\n\n  switch (mode) {\n    case 1:\n      this.mode = 'symmetric-active';\n      break;\n\n    case 2:\n      this.mode = 'symmetric-passive';\n      break;\n\n    case 3:\n      this.mode = 'client';\n      break;\n\n    case 4:\n      this.mode = 'server';\n      break;\n\n    case 5:\n      this.mode = 'broadcast';\n      break;\n\n    case 0:\n    case 6:\n    case 7:\n      this.mode = 'reserved';\n      break;\n  } // Stratum\n\n\n  var stratum = buffer[1];\n\n  if (stratum === 0) {\n    this.stratum = 'death';\n  } else if (stratum === 1) {\n    this.stratum = 'primary';\n  } else if (stratum <= 15) {\n    this.stratum = 'secondary';\n  } else {\n    this.stratum = 'reserved';\n  } // Poll interval (msec)\n\n\n  this.pollInterval = Math.round(Math.pow(2, buffer[2])) * 1000; // Precision (msecs)\n\n  this.precision = Math.pow(2, buffer[3]) * 1000; // Root delay (msecs)\n\n  var rootDelay = 256 * (256 * (256 * buffer[4] + buffer[5]) + buffer[6]) + buffer[7];\n  this.rootDelay = 1000 * (rootDelay / 0x10000); // Root dispersion (msecs)\n\n  this.rootDispersion = ((buffer[8] << 8) + buffer[9] + ((buffer[10] << 8) + buffer[11]) / Math.pow(2, 16)) * 1000; // Reference identifier\n\n  this.referenceId = '';\n\n  switch (this.stratum) {\n    case 'death':\n    case 'primary':\n      this.referenceId = String.fromCharCode(buffer[12]) + String.fromCharCode(buffer[13]) + String.fromCharCode(buffer[14]) + String.fromCharCode(buffer[15]);\n      break;\n\n    case 'secondary':\n      this.referenceId = '' + buffer[12] + '.' + buffer[13] + '.' + buffer[14] + '.' + buffer[15];\n      break;\n  } // Reference timestamp\n\n\n  this.referenceTimestamp = internals.toMsecs(buffer, 16); // Originate timestamp\n\n  this.originateTimestamp = internals.toMsecs(buffer, 24); // Receive timestamp\n\n  this.receiveTimestamp = internals.toMsecs(buffer, 32); // Transmit timestamp\n\n  this.transmitTimestamp = internals.toMsecs(buffer, 40); // Validate\n\n  if (this.version === 4 && this.stratum !== 'reserved' && this.mode === 'server' && this.originateTimestamp && this.receiveTimestamp && this.transmitTimestamp) {\n    this.isValid = true;\n  }\n\n  return this;\n};\n\ninternals.toMsecs = function (buffer, offset) {\n  var seconds = 0;\n  var fraction = 0;\n\n  for (var i = 0; i < 4; ++i) {\n    seconds = seconds * 256 + buffer[offset + i];\n  }\n\n  for (i = 4; i < 8; ++i) {\n    fraction = fraction * 256 + buffer[offset + i];\n  }\n\n  return (seconds - 2208988800 + fraction / Math.pow(2, 32)) * 1000;\n};\n\ninternals.fromMsecs = function (ts, buffer, offset) {\n  var seconds = Math.floor(ts / 1000) + 2208988800;\n  var fraction = Math.round(ts % 1000 / 1000 * Math.pow(2, 32));\n  buffer[offset + 0] = (seconds & 0xFF000000) >> 24;\n  buffer[offset + 1] = (seconds & 0x00FF0000) >> 16;\n  buffer[offset + 2] = (seconds & 0x0000FF00) >> 8;\n  buffer[offset + 3] = seconds & 0x000000FF;\n  buffer[offset + 4] = (fraction & 0xFF000000) >> 24;\n  buffer[offset + 5] = (fraction & 0x00FF0000) >> 16;\n  buffer[offset + 6] = (fraction & 0x0000FF00) >> 8;\n  buffer[offset + 7] = fraction & 0x000000FF;\n}; // Offset singleton\n\n\ninternals.last = {\n  offset: 0,\n  expires: 0,\n  host: '',\n  port: 0\n};\n\nexports.offset = function (options, callback) {\n  if (arguments.length !== 2) {\n    callback = arguments[0];\n    options = {};\n  }\n\n  var now = Date.now();\n  var clockSyncRefresh = options.clockSyncRefresh || 24 * 60 * 60 * 1000; // Daily\n\n  if (internals.last.offset && internals.last.host === options.host && internals.last.port === options.port && now < internals.last.expires) {\n    return callback(null, internals.last.offset);\n  }\n\n  exports.time(options, function (err, time) {\n    if (err) {\n      return callback(err, 0);\n    }\n\n    internals.last = {\n      offset: Math.round(time.t),\n      expires: now + clockSyncRefresh,\n      host: options.host,\n      port: options.port\n    };\n    return callback(null, internals.last.offset);\n  });\n}; // Now singleton\n\n\ninternals.now = {\n  intervalId: 0\n};\n\nexports.start = function (options, callback) {\n  if (arguments.length !== 2) {\n    callback = arguments[0];\n    options = {};\n  }\n\n  if (internals.now.intervalId) {\n    return callback();\n  }\n\n  exports.offset(options, function (err, offset) {\n    internals.now.intervalId = setInterval(function () {\n      exports.offset(options, function () {});\n    }, options.clockSyncRefresh || 24 * 60 * 60 * 1000); // Daily\n\n    return callback();\n  });\n};\n\nexports.stop = function () {\n  if (!internals.now.intervalId) {\n    return;\n  }\n\n  clearInterval(internals.now.intervalId);\n  internals.now.intervalId = 0;\n};\n\nexports.isLive = function () {\n  return !!internals.now.intervalId;\n};\n\nexports.now = function () {\n  var now = Date.now();\n\n  if (!exports.isLive() || now >= internals.last.expires) {\n    return now;\n  }\n\n  return now + internals.last.offset;\n};","map":{"version":3,"sources":["C:/react/quiz/node_modules/sntp/lib/index.js"],"names":["Dgram","require","Dns","Hoek","internals","exports","time","options","callback","arguments","length","settings","clone","host","port","resolveReference","timeoutId","sent","isFinished","finish","err","result","clearTimeout","socket","close","createSocket","on","buffer","rinfo","received","Date","now","message","NtpMessage","isValid","Error","originateTimestamp","T1","T2","receiveTimestamp","T3","transmitTimestamp","T4","d","t","receivedLocally","stratum","reverse","referenceId","domains","referenceHost","timeout","setTimeout","Buffer","i","fromMsecs","send","bytes","li","leapIndicator","vn","version","mode","pollInterval","Math","round","pow","precision","rootDelay","rootDispersion","String","fromCharCode","referenceTimestamp","toMsecs","offset","seconds","fraction","ts","floor","last","expires","clockSyncRefresh","intervalId","start","setInterval","stop","clearInterval","isLive"],"mappings":"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","sourcesContent":["// Load modules\r\n\r\nvar Dgram = require('dgram');\r\nvar Dns = require('dns');\r\nvar Hoek = require('hoek');\r\n\r\n\r\n// Declare internals\r\n\r\nvar internals = {};\r\n\r\n\r\nexports.time = function (options, callback) {\r\n\r\n    if (arguments.length !== 2) {\r\n        callback = arguments[0];\r\n        options = {};\r\n    }\r\n\r\n    var settings = Hoek.clone(options);\r\n    settings.host = settings.host || 'pool.ntp.org';\r\n    settings.port = settings.port || 123;\r\n    settings.resolveReference = settings.resolveReference || false;\r\n\r\n    // Declare variables used by callback\r\n\r\n    var timeoutId = 0;\r\n    var sent = 0;\r\n\r\n    // Ensure callback is only called once\r\n\r\n    var isFinished = false;\r\n    var finish = function (err, result) {\r\n\r\n        if (timeoutId) {\r\n            clearTimeout(timeoutId);\r\n            timeoutId = 0;\r\n        }\r\n\r\n        if (!isFinished) {\r\n            isFinished = true;\r\n            socket.close();\r\n            return callback(err, result);\r\n        }\r\n    };\r\n\r\n    // Create UDP socket\r\n\r\n    var socket = Dgram.createSocket('udp4');\r\n\r\n    socket.on('error', function (err) {\r\n\r\n        return finish(err);\r\n    });\r\n\r\n    // Listen to incoming messages\r\n\r\n    socket.on('message', function (buffer, rinfo) {\r\n\r\n        var received = Date.now();\r\n\r\n        var message = new internals.NtpMessage(buffer);\r\n        if (!message.isValid) {\r\n            return finish(new Error('Invalid server response'), message);\r\n        }\r\n\r\n        if (message.originateTimestamp !== sent) {\r\n            return finish(new Error('Wrong originate timestamp'), message);\r\n        }\r\n\r\n        // Timestamp Name          ID   When Generated\r\n        // ------------------------------------------------------------\r\n        // Originate Timestamp     T1   time request sent by client\r\n        // Receive Timestamp       T2   time request received by server\r\n        // Transmit Timestamp      T3   time reply sent by server\r\n        // Destination Timestamp   T4   time reply received by client\r\n        //\r\n        // The roundtrip delay d and system clock offset t are defined as:\r\n        //\r\n        // d = (T4 - T1) - (T3 - T2)     t = ((T2 - T1) + (T3 - T4)) / 2\r\n\r\n        var T1 = message.originateTimestamp;\r\n        var T2 = message.receiveTimestamp;\r\n        var T3 = message.transmitTimestamp;\r\n        var T4 = received;\r\n\r\n        message.d = (T4 - T1) - (T3 - T2);\r\n        message.t = ((T2 - T1) + (T3 - T4)) / 2;\r\n        message.receivedLocally = received;\r\n\r\n        if (!settings.resolveReference ||\r\n            message.stratum !== 'secondary') {\r\n\r\n            return finish(null, message);\r\n        }\r\n\r\n        // Resolve reference IP address\r\n\r\n        Dns.reverse(message.referenceId, function (err, domains) {\r\n\r\n            if (!err) {\r\n                message.referenceHost = domains[0];\r\n            }\r\n\r\n            return finish(null, message);\r\n        });\r\n    });\r\n\r\n    // Set timeout\r\n\r\n    if (settings.timeout) {\r\n        timeoutId = setTimeout(function () {\r\n\r\n            timeoutId = 0;\r\n            return finish(new Error('Timeout'));\r\n        }, settings.timeout);\r\n    }\r\n\r\n    // Construct NTP message\r\n\r\n    var message = new Buffer(48);\r\n    for (var i = 0; i < 48; i++) {                      // Zero message\r\n        message[i] = 0;\r\n    }\r\n\r\n    message[0] = (0 << 6) + (4 << 3) + (3 << 0)         // Set version number to 4 and Mode to 3 (client)\r\n    sent = Date.now();\r\n    internals.fromMsecs(sent, message, 40);               // Set transmit timestamp (returns as originate)\r\n\r\n    // Send NTP request\r\n\r\n    socket.send(message, 0, message.length, settings.port, settings.host, function (err, bytes) {\r\n\r\n        if (err ||\r\n            bytes !== 48) {\r\n\r\n            return finish(err || new Error('Could not send entire message'));\r\n        }\r\n    });\r\n};\r\n\r\n\r\ninternals.NtpMessage = function (buffer) {\r\n\r\n    this.isValid = false;\r\n\r\n    // Validate\r\n\r\n    if (buffer.length !== 48) {\r\n        return;\r\n    }\r\n\r\n    // Leap indicator\r\n\r\n    var li = (buffer[0] >> 6);\r\n    switch (li) {\r\n        case 0: this.leapIndicator = 'no-warning'; break;\r\n        case 1: this.leapIndicator = 'last-minute-61'; break;\r\n        case 2: this.leapIndicator = 'last-minute-59'; break;\r\n        case 3: this.leapIndicator = 'alarm'; break;\r\n    }\r\n\r\n    // Version\r\n\r\n    var vn = ((buffer[0] & 0x38) >> 3);\r\n    this.version = vn;\r\n\r\n    // Mode\r\n\r\n    var mode = (buffer[0] & 0x7);\r\n    switch (mode) {\r\n        case 1: this.mode = 'symmetric-active'; break;\r\n        case 2: this.mode = 'symmetric-passive'; break;\r\n        case 3: this.mode = 'client'; break;\r\n        case 4: this.mode = 'server'; break;\r\n        case 5: this.mode = 'broadcast'; break;\r\n        case 0:\r\n        case 6:\r\n        case 7: this.mode = 'reserved'; break;\r\n    }\r\n\r\n    // Stratum\r\n\r\n    var stratum = buffer[1];\r\n    if (stratum === 0) {\r\n        this.stratum = 'death';\r\n    }\r\n    else if (stratum === 1) {\r\n        this.stratum = 'primary';\r\n    }\r\n    else if (stratum <= 15) {\r\n        this.stratum = 'secondary';\r\n    }\r\n    else {\r\n        this.stratum = 'reserved';\r\n    }\r\n\r\n    // Poll interval (msec)\r\n\r\n    this.pollInterval = Math.round(Math.pow(2, buffer[2])) * 1000;\r\n\r\n    // Precision (msecs)\r\n\r\n    this.precision = Math.pow(2, buffer[3]) * 1000;\r\n\r\n    // Root delay (msecs)\r\n\r\n    var rootDelay = 256 * (256 * (256 * buffer[4] + buffer[5]) + buffer[6]) + buffer[7];\r\n    this.rootDelay = 1000 * (rootDelay / 0x10000);\r\n\r\n    // Root dispersion (msecs)\r\n\r\n    this.rootDispersion = ((buffer[8] << 8) + buffer[9] + ((buffer[10] << 8) + buffer[11]) / Math.pow(2, 16)) * 1000;\r\n\r\n    // Reference identifier\r\n\r\n    this.referenceId = '';\r\n    switch (this.stratum) {\r\n        case 'death':\r\n        case 'primary':\r\n            this.referenceId = String.fromCharCode(buffer[12]) + String.fromCharCode(buffer[13]) + String.fromCharCode(buffer[14]) + String.fromCharCode(buffer[15]);\r\n            break;\r\n        case 'secondary':\r\n            this.referenceId = '' + buffer[12] + '.' + buffer[13] + '.' + buffer[14] + '.' + buffer[15];\r\n            break;\r\n    }\r\n\r\n    // Reference timestamp\r\n\r\n    this.referenceTimestamp = internals.toMsecs(buffer, 16);\r\n\r\n    // Originate timestamp\r\n\r\n    this.originateTimestamp = internals.toMsecs(buffer, 24);\r\n\r\n    // Receive timestamp\r\n\r\n    this.receiveTimestamp = internals.toMsecs(buffer, 32);\r\n\r\n    // Transmit timestamp\r\n\r\n    this.transmitTimestamp = internals.toMsecs(buffer, 40);\r\n\r\n    // Validate\r\n\r\n    if (this.version === 4 &&\r\n        this.stratum !== 'reserved' &&\r\n        this.mode === 'server' &&\r\n        this.originateTimestamp &&\r\n        this.receiveTimestamp &&\r\n        this.transmitTimestamp) {\r\n\r\n        this.isValid = true;\r\n    }\r\n\r\n    return this;\r\n};\r\n\r\n\r\ninternals.toMsecs = function (buffer, offset) {\r\n\r\n    var seconds = 0;\r\n    var fraction = 0;\r\n\r\n    for (var i = 0; i < 4; ++i) {\r\n        seconds = (seconds * 256) + buffer[offset + i];\r\n    }\r\n\r\n    for (i = 4; i < 8; ++i) {\r\n        fraction = (fraction * 256) + buffer[offset + i];\r\n    }\r\n\r\n    return ((seconds - 2208988800 + (fraction / Math.pow(2, 32))) * 1000);\r\n};\r\n\r\n\r\ninternals.fromMsecs = function (ts, buffer, offset) {\r\n\r\n    var seconds = Math.floor(ts / 1000) + 2208988800;\r\n    var fraction = Math.round((ts % 1000) / 1000 * Math.pow(2, 32));\r\n\r\n    buffer[offset + 0] = (seconds & 0xFF000000) >> 24;\r\n    buffer[offset + 1] = (seconds & 0x00FF0000) >> 16;\r\n    buffer[offset + 2] = (seconds & 0x0000FF00) >> 8;\r\n    buffer[offset + 3] = (seconds & 0x000000FF);\r\n\r\n    buffer[offset + 4] = (fraction & 0xFF000000) >> 24;\r\n    buffer[offset + 5] = (fraction & 0x00FF0000) >> 16;\r\n    buffer[offset + 6] = (fraction & 0x0000FF00) >> 8;\r\n    buffer[offset + 7] = (fraction & 0x000000FF);\r\n};\r\n\r\n\r\n// Offset singleton\r\n\r\ninternals.last = {\r\n    offset: 0,\r\n    expires: 0,\r\n    host: '',\r\n    port: 0\r\n};\r\n\r\n\r\nexports.offset = function (options, callback) {\r\n\r\n    if (arguments.length !== 2) {\r\n        callback = arguments[0];\r\n        options = {};\r\n    }\r\n\r\n    var now = Date.now();\r\n    var clockSyncRefresh = options.clockSyncRefresh || 24 * 60 * 60 * 1000;                    // Daily\r\n\r\n    if (internals.last.offset &&\r\n        internals.last.host === options.host &&\r\n        internals.last.port === options.port &&\r\n        now < internals.last.expires) {\r\n\r\n        return callback(null, internals.last.offset);\r\n    }\r\n\r\n    exports.time(options, function (err, time) {\r\n\r\n        if (err) {\r\n            return callback(err, 0);\r\n        }\r\n\r\n        internals.last = {\r\n            offset: Math.round(time.t),\r\n            expires: now + clockSyncRefresh,\r\n            host: options.host,\r\n            port: options.port\r\n        };\r\n\r\n        return callback(null, internals.last.offset);\r\n    });\r\n};\r\n\r\n\r\n// Now singleton\r\n\r\ninternals.now = {\r\n    intervalId: 0\r\n};\r\n\r\n\r\nexports.start = function (options, callback) {\r\n\r\n    if (arguments.length !== 2) {\r\n        callback = arguments[0];\r\n        options = {};\r\n    }\r\n\r\n    if (internals.now.intervalId) {\r\n        return callback();\r\n    }\r\n\r\n    exports.offset(options, function (err, offset) {\r\n\r\n        internals.now.intervalId = setInterval(function () {\r\n\r\n            exports.offset(options, function () { });\r\n        }, options.clockSyncRefresh || 24 * 60 * 60 * 1000);                                // Daily\r\n\r\n        return callback();\r\n    });\r\n};\r\n\r\n\r\nexports.stop = function () {\r\n\r\n    if (!internals.now.intervalId) {\r\n        return;\r\n    }\r\n\r\n    clearInterval(internals.now.intervalId);\r\n    internals.now.intervalId = 0;\r\n};\r\n\r\n\r\nexports.isLive = function () {\r\n\r\n    return !!internals.now.intervalId;\r\n};\r\n\r\n\r\nexports.now = function () {\r\n\r\n    var now = Date.now();\r\n    if (!exports.isLive() ||\r\n        now >= internals.last.expires) {\r\n\r\n        return now;\r\n    }\r\n\r\n    return now + internals.last.offset;\r\n};\r\n\r\n"]},"metadata":{},"sourceType":"script"}