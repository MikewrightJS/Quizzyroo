{"ast":null,"code":"// Copyright 2010-2012 Mikeal Rogers\n//\n//    Licensed under the Apache License, Version 2.0 (the \"License\");\n//    you may not use this file except in compliance with the License.\n//    You may obtain a copy of the License at\n//\n//        http://www.apache.org/licenses/LICENSE-2.0\n//\n//    Unless required by applicable law or agreed to in writing, software\n//    distributed under the License is distributed on an \"AS IS\" BASIS,\n//    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n//    See the License for the specific language governing permissions and\n//    limitations under the License.\nvar http = require('http'),\n    https = false,\n    tls = false,\n    url = require('url'),\n    util = require('util'),\n    stream = require('stream'),\n    qs = require('qs'),\n    querystring = require('querystring'),\n    crypto = require('crypto'),\n    oauth = require('oauth-sign'),\n    hawk = require('hawk'),\n    aws = require('aws-sign'),\n    uuid = require('node-uuid'),\n    mime = require('mime'),\n    tunnel = require('tunnel-agent'),\n    safeStringify = require('json-stringify-safe'),\n    ForeverAgent = require('forever-agent'),\n    FormData = require('form-data'),\n    Cookie = require('cookie-jar'),\n    CookieJar = Cookie.Jar,\n    cookieJar = new CookieJar();\n\ntry {\n  https = require('https');\n} catch (e) {}\n\ntry {\n  tls = require('tls');\n} catch (e) {}\n\nvar debug;\n\nif (/\\brequest\\b/.test(process.env.NODE_DEBUG)) {\n  debug = function () {\n    console.error('REQUEST %s', util.format.apply(util, arguments));\n  };\n} else {\n  debug = function () {};\n}\n\nfunction toBase64(str) {\n  return new Buffer(str || \"\", \"ascii\").toString(\"base64\");\n}\n\nfunction md5(str) {\n  return crypto.createHash('md5').update(str).digest('hex');\n} // Hacky fix for pre-0.4.4 https\n\n\nif (https && !https.Agent) {\n  https.Agent = function (options) {\n    http.Agent.call(this, options);\n  };\n\n  util.inherits(https.Agent, http.Agent);\n\n  https.Agent.prototype._getConnection = function (host, port, cb) {\n    var s = tls.connect(port, host, this.options, function () {\n      // do other checks here?\n      if (cb) cb();\n    });\n    return s;\n  };\n}\n\nfunction isReadStream(rs) {\n  if (rs.readable && rs.path && rs.mode) {\n    return true;\n  }\n}\n\nfunction copy(obj) {\n  var o = {};\n  Object.keys(obj).forEach(function (i) {\n    o[i] = obj[i];\n  });\n  return o;\n}\n\nvar isUrl = /^https?:/;\nvar globalPool = {};\n\nfunction Request(options) {\n  stream.Stream.call(this);\n  this.readable = true;\n  this.writable = true;\n\n  if (typeof options === 'string') {\n    options = {\n      uri: options\n    };\n  }\n\n  var reserved = Object.keys(Request.prototype);\n\n  for (var i in options) {\n    if (reserved.indexOf(i) === -1) {\n      this[i] = options[i];\n    } else {\n      if (typeof options[i] === 'function') {\n        delete options[i];\n      }\n    }\n  }\n\n  this.init(options);\n}\n\nutil.inherits(Request, stream.Stream);\n\nRequest.prototype.init = function (options) {\n  // init() contains all the code to setup the request object.\n  // the actual outgoing request is not started until start() is called\n  // this function is called from both the constructor and on redirect.\n  var self = this;\n  if (!options) options = {};\n  self.method = options.method || 'GET';\n  debug(options);\n  if (!self.pool && self.pool !== false) self.pool = globalPool;\n  self.dests = self.dests || [];\n  self.__isRequestRequest = true; // Protect against double callback\n\n  if (!self._callback && self.callback) {\n    self._callback = self.callback;\n\n    self.callback = function () {\n      if (self._callbackCalled) return; // Print a warning maybe?\n\n      self._callbackCalled = true;\n\n      self._callback.apply(self, arguments);\n    };\n\n    self.on('error', self.callback.bind());\n    self.on('complete', self.callback.bind(self, null));\n  }\n\n  if (self.url) {\n    // People use this property instead all the time so why not just support it.\n    self.uri = self.url;\n    delete self.url;\n  }\n\n  if (!self.uri) {\n    // this will throw if unhandled but is handleable when in a redirect\n    return self.emit('error', new Error(\"options.uri is a required argument\"));\n  } else {\n    if (typeof self.uri == \"string\") self.uri = url.parse(self.uri);\n  }\n\n  if (self.proxy) {\n    if (typeof self.proxy == 'string') self.proxy = url.parse(self.proxy); // do the HTTP CONNECT dance using koichik/node-tunnel\n\n    if (http.globalAgent && self.uri.protocol === \"https:\") {\n      var tunnelFn = self.proxy.protocol === \"http:\" ? tunnel.httpsOverHttp : tunnel.httpsOverHttps;\n      var tunnelOptions = {\n        proxy: {\n          host: self.proxy.hostname,\n          port: +self.proxy.port,\n          proxyAuth: self.proxy.auth,\n          headers: {\n            Host: self.uri.hostname + ':' + (self.uri.port || self.uri.protocol === 'https:' ? 443 : 80)\n          }\n        },\n        ca: this.ca\n      };\n      self.agent = tunnelFn(tunnelOptions);\n      self.tunnel = true;\n    }\n  }\n\n  if (!self.uri.host || !self.uri.pathname) {\n    // Invalid URI: it may generate lot of bad errors, like \"TypeError: Cannot call method 'indexOf' of undefined\" in CookieJar\n    // Detect and reject it as soon as possible\n    var faultyUri = url.format(self.uri);\n    var message = 'Invalid URI \"' + faultyUri + '\"';\n\n    if (Object.keys(options).length === 0) {\n      // No option ? This can be the sign of a redirect\n      // As this is a case where the user cannot do anything (he didn't call request directly with this URL)\n      // he should be warned that it can be caused by a redirection (can save some hair)\n      message += '. This can be caused by a crappy redirection.';\n    }\n\n    self.emit('error', new Error(message));\n    return; // This error was fatal\n  }\n\n  self._redirectsFollowed = self._redirectsFollowed || 0;\n  self.maxRedirects = self.maxRedirects !== undefined ? self.maxRedirects : 10;\n  self.followRedirect = self.followRedirect !== undefined ? self.followRedirect : true;\n  self.followAllRedirects = self.followAllRedirects !== undefined ? self.followAllRedirects : false;\n  if (self.followRedirect || self.followAllRedirects) self.redirects = self.redirects || [];\n  self.headers = self.headers ? copy(self.headers) : {};\n  self.setHost = false;\n\n  if (!(self.headers.host || self.headers.Host)) {\n    self.headers.host = self.uri.hostname;\n\n    if (self.uri.port) {\n      if (!(self.uri.port === 80 && self.uri.protocol === 'http:') && !(self.uri.port === 443 && self.uri.protocol === 'https:')) self.headers.host += ':' + self.uri.port;\n    }\n\n    self.setHost = true;\n  }\n\n  self.jar(self._jar || options.jar);\n\n  if (!self.uri.pathname) {\n    self.uri.pathname = '/';\n  }\n\n  if (!self.uri.port) {\n    if (self.uri.protocol == 'http:') {\n      self.uri.port = 80;\n    } else if (self.uri.protocol == 'https:') {\n      self.uri.port = 443;\n    }\n  }\n\n  if (self.proxy && !self.tunnel) {\n    self.port = self.proxy.port;\n    self.host = self.proxy.hostname;\n  } else {\n    self.port = self.uri.port;\n    self.host = self.uri.hostname;\n  }\n\n  self.clientErrorHandler = function (error) {\n    if (self._aborted) return;\n\n    if (self.req && self.req._reusedSocket && error.code === 'ECONNRESET' && self.agent.addRequestNoreuse) {\n      self.agent = {\n        addRequest: self.agent.addRequestNoreuse.bind(self.agent)\n      };\n      self.start();\n      self.req.end();\n      return;\n    }\n\n    if (self.timeout && self.timeoutTimer) {\n      clearTimeout(self.timeoutTimer);\n      self.timeoutTimer = null;\n    }\n\n    self.emit('error', error);\n  };\n\n  self._parserErrorHandler = function (error) {\n    if (this.res) {\n      if (this.res.request) {\n        this.res.request.emit('error', error);\n      } else {\n        this.res.emit('error', error);\n      }\n    } else {\n      this._httpMessage.emit('error', error);\n    }\n  };\n\n  if (options.form) {\n    self.form(options.form);\n  }\n\n  if (options.qs) self.qs(options.qs);\n\n  if (self.uri.path) {\n    self.path = self.uri.path;\n  } else {\n    self.path = self.uri.pathname + (self.uri.search || \"\");\n  }\n\n  if (self.path.length === 0) self.path = '/'; // Auth must happen last in case signing is dependent on other headers\n\n  if (options.oauth) {\n    self.oauth(options.oauth);\n  }\n\n  if (options.aws) {\n    self.aws(options.aws);\n  }\n\n  if (options.hawk) {\n    self.hawk(options.hawk);\n  }\n\n  if (options.auth) {\n    self.auth(options.auth.user || options.auth.username, options.auth.pass || options.auth.password, options.auth.sendImmediately);\n  }\n\n  if (self.uri.auth && !self.headers.authorization) {\n    var authPieces = self.uri.auth.split(':').map(function (item) {\n      return querystring.unescape(item);\n    });\n    self.auth(authPieces[0], authPieces[1], true);\n  }\n\n  if (self.proxy && self.proxy.auth && !self.headers['proxy-authorization'] && !self.tunnel) {\n    self.headers['proxy-authorization'] = \"Basic \" + toBase64(self.proxy.auth.split(':').map(function (item) {\n      return querystring.unescape(item);\n    }).join(':'));\n  }\n\n  if (self.proxy && !self.tunnel) self.path = self.uri.protocol + '//' + self.uri.host + self.path;\n\n  if (options.json) {\n    self.json(options.json);\n  } else if (options.multipart) {\n    self.boundary = uuid();\n    self.multipart(options.multipart);\n  }\n\n  if (self.body) {\n    var length = 0;\n\n    if (!Buffer.isBuffer(self.body)) {\n      if (Array.isArray(self.body)) {\n        for (var i = 0; i < self.body.length; i++) {\n          length += self.body[i].length;\n        }\n      } else {\n        self.body = new Buffer(self.body);\n        length = self.body.length;\n      }\n    } else {\n      length = self.body.length;\n    }\n\n    if (length) {\n      if (!self.headers['content-length'] && !self.headers['Content-Length']) self.headers['content-length'] = length;\n    } else {\n      throw new Error('Argument error, options.body.');\n    }\n  }\n\n  var protocol = self.proxy && !self.tunnel ? self.proxy.protocol : self.uri.protocol,\n      defaultModules = {\n    'http:': http,\n    'https:': https\n  },\n      httpModules = self.httpModules || {};\n  self.httpModule = httpModules[protocol] || defaultModules[protocol];\n  if (!self.httpModule) return this.emit('error', new Error(\"Invalid protocol\"));\n  if (options.ca) self.ca = options.ca;\n\n  if (!self.agent) {\n    if (options.agentOptions) self.agentOptions = options.agentOptions;\n\n    if (options.agentClass) {\n      self.agentClass = options.agentClass;\n    } else if (options.forever) {\n      self.agentClass = protocol === 'http:' ? ForeverAgent : ForeverAgent.SSL;\n    } else {\n      self.agentClass = self.httpModule.Agent;\n    }\n  }\n\n  if (self.strictSSL === false) {\n    self.rejectUnauthorized = false;\n  }\n\n  if (self.pool === false) {\n    self.agent = false;\n  } else {\n    self.agent = self.agent || self.getAgent();\n\n    if (self.maxSockets) {\n      // Don't use our pooling if node has the refactored client\n      self.agent.maxSockets = self.maxSockets;\n    }\n\n    if (self.pool.maxSockets) {\n      // Don't use our pooling if node has the refactored client\n      self.agent.maxSockets = self.pool.maxSockets;\n    }\n  }\n\n  self.once('pipe', function (src) {\n    if (self.ntick && self._started) throw new Error(\"You cannot pipe to this stream after the outbound request has started.\");\n    self.src = src;\n\n    if (isReadStream(src)) {\n      if (!self.headers['content-type'] && !self.headers['Content-Type']) self.headers['content-type'] = mime.lookup(src.path);\n    } else {\n      if (src.headers) {\n        for (var i in src.headers) {\n          if (!self.headers[i]) {\n            self.headers[i] = src.headers[i];\n          }\n        }\n      }\n\n      if (self._json && !self.headers['content-type'] && !self.headers['Content-Type']) self.headers['content-type'] = 'application/json';\n\n      if (src.method && !self.method) {\n        self.method = src.method;\n      }\n    }\n\n    self.on('pipe', function () {\n      console.error(\"You have already piped to this stream. Pipeing twice is likely to break the request.\");\n    });\n  });\n  process.nextTick(function () {\n    if (self._aborted) return;\n\n    if (self._form) {\n      self.setHeaders(self._form.getHeaders());\n\n      self._form.pipe(self);\n    }\n\n    if (self.body) {\n      if (Array.isArray(self.body)) {\n        self.body.forEach(function (part) {\n          self.write(part);\n        });\n      } else {\n        self.write(self.body);\n      }\n\n      self.end();\n    } else if (self.requestBodyStream) {\n      console.warn(\"options.requestBodyStream is deprecated, please pass the request object to stream.pipe.\");\n      self.requestBodyStream.pipe(self);\n    } else if (!self.src) {\n      if (self.method !== 'GET' && typeof self.method !== 'undefined') {\n        self.headers['content-length'] = 0;\n      }\n\n      self.end();\n    }\n\n    self.ntick = true;\n  });\n}; // Must call this when following a redirect from https to http or vice versa\n// Attempts to keep everything as identical as possible, but update the\n// httpModule, Tunneling agent, and/or Forever Agent in use.\n\n\nRequest.prototype._updateProtocol = function () {\n  var self = this;\n  var protocol = self.uri.protocol;\n\n  if (protocol === 'https:') {\n    // previously was doing http, now doing https\n    // if it's https, then we might need to tunnel now.\n    if (self.proxy) {\n      self.tunnel = true;\n      var tunnelFn = self.proxy.protocol === 'http:' ? tunnel.httpsOverHttp : tunnel.httpsOverHttps;\n      var tunnelOptions = {\n        proxy: {\n          host: self.proxy.hostname,\n          port: +self.proxy.port,\n          proxyAuth: self.proxy.auth\n        },\n        ca: self.ca\n      };\n      self.agent = tunnelFn(tunnelOptions);\n      return;\n    }\n\n    self.httpModule = https;\n\n    switch (self.agentClass) {\n      case ForeverAgent:\n        self.agentClass = ForeverAgent.SSL;\n        break;\n\n      case http.Agent:\n        self.agentClass = https.Agent;\n        break;\n\n      default:\n        // nothing we can do.  Just hope for the best.\n        return;\n    } // if there's an agent, we need to get a new one.\n\n\n    if (self.agent) self.agent = self.getAgent();\n  } else {\n    // previously was doing https, now doing http\n    // stop any tunneling.\n    if (self.tunnel) self.tunnel = false;\n    self.httpModule = http;\n\n    switch (self.agentClass) {\n      case ForeverAgent.SSL:\n        self.agentClass = ForeverAgent;\n        break;\n\n      case https.Agent:\n        self.agentClass = http.Agent;\n        break;\n\n      default:\n        // nothing we can do.  just hope for the best\n        return;\n    } // if there's an agent, then get a new one.\n\n\n    if (self.agent) {\n      self.agent = null;\n      self.agent = self.getAgent();\n    }\n  }\n};\n\nRequest.prototype.getAgent = function () {\n  var Agent = this.agentClass;\n  var options = {};\n\n  if (this.agentOptions) {\n    for (var i in this.agentOptions) {\n      options[i] = this.agentOptions[i];\n    }\n  }\n\n  if (this.ca) options.ca = this.ca;\n  if (typeof this.rejectUnauthorized !== 'undefined') options.rejectUnauthorized = this.rejectUnauthorized;\n\n  if (this.cert && this.key) {\n    options.key = this.key;\n    options.cert = this.cert;\n  }\n\n  var poolKey = ''; // different types of agents are in different pools\n\n  if (Agent !== this.httpModule.Agent) {\n    poolKey += Agent.name;\n  }\n\n  if (!this.httpModule.globalAgent) {\n    // node 0.4.x\n    options.host = this.host;\n    options.port = this.port;\n    if (poolKey) poolKey += ':';\n    poolKey += this.host + ':' + this.port;\n  } // ca option is only relevant if proxy or destination are https\n\n\n  var proxy = this.proxy;\n  if (typeof proxy === 'string') proxy = url.parse(proxy);\n  var isHttps = proxy && proxy.protocol === 'https:' || this.uri.protocol === 'https:';\n\n  if (isHttps) {\n    if (options.ca) {\n      if (poolKey) poolKey += ':';\n      poolKey += options.ca;\n    }\n\n    if (typeof options.rejectUnauthorized !== 'undefined') {\n      if (poolKey) poolKey += ':';\n      poolKey += options.rejectUnauthorized;\n    }\n\n    if (options.cert) poolKey += options.cert.toString('ascii') + options.key.toString('ascii');\n  }\n\n  if (!poolKey && Agent === this.httpModule.Agent && this.httpModule.globalAgent) {\n    // not doing anything special.  Use the globalAgent\n    return this.httpModule.globalAgent;\n  } // we're using a stored agent.  Make sure it's protocol-specific\n\n\n  poolKey = this.uri.protocol + poolKey; // already generated an agent for this setting\n\n  if (this.pool[poolKey]) return this.pool[poolKey];\n  return this.pool[poolKey] = new Agent(options);\n};\n\nRequest.prototype.start = function () {\n  // start() is called once we are ready to send the outgoing HTTP request.\n  // this is usually called on the first write(), end() or on nextTick()\n  var self = this;\n  if (self._aborted) return;\n  self._started = true;\n  self.method = self.method || 'GET';\n  self.href = self.uri.href;\n\n  if (self.src && self.src.stat && self.src.stat.size && !self.headers['content-length'] && !self.headers['Content-Length']) {\n    self.headers['content-length'] = self.src.stat.size;\n  }\n\n  if (self._aws) {\n    self.aws(self._aws, true);\n  } // We have a method named auth, which is completely different from the http.request\n  // auth option.  If we don't remove it, we're gonna have a bad time.\n\n\n  var reqOptions = copy(self);\n  delete reqOptions.auth;\n  debug('make request', self.uri.href);\n  self.req = self.httpModule.request(reqOptions, self.onResponse.bind(self));\n\n  if (self.timeout && !self.timeoutTimer) {\n    self.timeoutTimer = setTimeout(function () {\n      self.req.abort();\n      var e = new Error(\"ETIMEDOUT\");\n      e.code = \"ETIMEDOUT\";\n      self.emit(\"error\", e);\n    }, self.timeout); // Set additional timeout on socket - in case if remote\n    // server freeze after sending headers\n\n    if (self.req.setTimeout) {\n      // only works on node 0.6+\n      self.req.setTimeout(self.timeout, function () {\n        if (self.req) {\n          self.req.abort();\n          var e = new Error(\"ESOCKETTIMEDOUT\");\n          e.code = \"ESOCKETTIMEDOUT\";\n          self.emit(\"error\", e);\n        }\n      });\n    }\n  }\n\n  self.req.on('error', self.clientErrorHandler);\n  self.req.on('drain', function () {\n    self.emit('drain');\n  });\n  self.on('end', function () {\n    if (self.req.connection) self.req.connection.removeListener('error', self._parserErrorHandler);\n  });\n  self.emit('request', self.req);\n};\n\nRequest.prototype.onResponse = function (response) {\n  var self = this;\n  debug('onResponse', self.uri.href, response.statusCode, response.headers);\n  response.on('end', function () {\n    debug('response end', self.uri.href, response.statusCode, response.headers);\n  });\n\n  if (response.connection.listeners('error').indexOf(self._parserErrorHandler) === -1) {\n    response.connection.once('error', self._parserErrorHandler);\n  }\n\n  if (self._aborted) {\n    debug('aborted', self.uri.href);\n    response.resume();\n    return;\n  }\n\n  if (self._paused) response.pause();else response.resume();\n  self.response = response;\n  response.request = self;\n  response.toJSON = toJSON; // XXX This is different on 0.10, because SSL is strict by default\n\n  if (self.httpModule === https && self.strictSSL && !response.client.authorized) {\n    debug('strict ssl error', self.uri.href);\n    var sslErr = response.client.authorizationError;\n    self.emit('error', new Error('SSL Error: ' + sslErr));\n    return;\n  }\n\n  if (self.setHost) delete self.headers.host;\n\n  if (self.timeout && self.timeoutTimer) {\n    clearTimeout(self.timeoutTimer);\n    self.timeoutTimer = null;\n  }\n\n  var addCookie = function (cookie) {\n    if (self._jar) self._jar.add(new Cookie(cookie));else cookieJar.add(new Cookie(cookie));\n  };\n\n  if (response.headers['set-cookie'] && !self._disableCookies) {\n    if (Array.isArray(response.headers['set-cookie'])) response.headers['set-cookie'].forEach(addCookie);else addCookie(response.headers['set-cookie']);\n  }\n\n  var redirectTo = null;\n\n  if (response.statusCode >= 300 && response.statusCode < 400 && response.headers.location) {\n    debug('redirect', response.headers.location);\n\n    if (self.followAllRedirects) {\n      redirectTo = response.headers.location;\n    } else if (self.followRedirect) {\n      switch (self.method) {\n        case 'PATCH':\n        case 'PUT':\n        case 'POST':\n        case 'DELETE':\n          // Do not follow redirects\n          break;\n\n        default:\n          redirectTo = response.headers.location;\n          break;\n      }\n    }\n  } else if (response.statusCode == 401 && self._hasAuth && !self._sentAuth) {\n    var authHeader = response.headers['www-authenticate'];\n    var authVerb = authHeader && authHeader.split(' ')[0];\n    debug('reauth', authVerb);\n\n    switch (authVerb) {\n      case 'Basic':\n        self.auth(self._user, self._pass, true);\n        redirectTo = self.uri;\n        break;\n\n      case 'Digest':\n        // TODO: More complete implementation of RFC 2617.  For reference:\n        // http://tools.ietf.org/html/rfc2617#section-3\n        // https://github.com/bagder/curl/blob/master/lib/http_digest.c\n        var matches = authHeader.match(/([a-z0-9_-]+)=\"([^\"]+)\"/gi);\n        var challenge = {};\n\n        for (var i = 0; i < matches.length; i++) {\n          var eqPos = matches[i].indexOf('=');\n          var key = matches[i].substring(0, eqPos);\n          var quotedValue = matches[i].substring(eqPos + 1);\n          challenge[key] = quotedValue.substring(1, quotedValue.length - 1);\n        }\n\n        var ha1 = md5(self._user + ':' + challenge.realm + ':' + self._pass);\n        var ha2 = md5(self.method + ':' + self.uri.path);\n        var digestResponse = md5(ha1 + ':' + challenge.nonce + ':1::auth:' + ha2);\n        var authValues = {\n          username: self._user,\n          realm: challenge.realm,\n          nonce: challenge.nonce,\n          uri: self.uri.path,\n          qop: challenge.qop,\n          response: digestResponse,\n          nc: 1,\n          cnonce: ''\n        };\n        authHeader = [];\n\n        for (var k in authValues) {\n          authHeader.push(k + '=\"' + authValues[k] + '\"');\n        }\n\n        authHeader = 'Digest ' + authHeader.join(', ');\n        self.setHeader('authorization', authHeader);\n        self._sentAuth = true;\n        redirectTo = self.uri;\n        break;\n    }\n  }\n\n  if (redirectTo) {\n    debug('redirect to', redirectTo); // ignore any potential response body.  it cannot possibly be useful\n    // to us at this point.\n\n    if (self._paused) response.resume();\n\n    if (self._redirectsFollowed >= self.maxRedirects) {\n      self.emit('error', new Error(\"Exceeded maxRedirects. Probably stuck in a redirect loop \" + self.uri.href));\n      return;\n    }\n\n    self._redirectsFollowed += 1;\n\n    if (!isUrl.test(redirectTo)) {\n      redirectTo = url.resolve(self.uri.href, redirectTo);\n    }\n\n    var uriPrev = self.uri;\n    self.uri = url.parse(redirectTo); // handle the case where we change protocol from https to http or vice versa\n\n    if (self.uri.protocol !== uriPrev.protocol) {\n      self._updateProtocol();\n    }\n\n    self.redirects.push({\n      statusCode: response.statusCode,\n      redirectUri: redirectTo\n    });\n    if (self.followAllRedirects && response.statusCode != 401) self.method = 'GET'; // self.method = 'GET' // Force all redirects to use GET || commented out fixes #215\n\n    delete self.src;\n    delete self.req;\n    delete self.agent;\n    delete self._started;\n\n    if (response.statusCode != 401) {\n      delete self.body;\n      delete self._form;\n    }\n\n    if (self.headers) {\n      delete self.headers.host;\n      delete self.headers['content-type'];\n      delete self.headers['content-length'];\n    }\n\n    self.init();\n    return; // Ignore the rest of the response\n  } else {\n    self._redirectsFollowed = self._redirectsFollowed || 0; // Be a good stream and emit end when the response is finished.\n    // Hack to emit end on close because of a core bug that never fires end\n\n    response.on('close', function () {\n      if (!self._ended) self.response.emit('end');\n    });\n\n    if (self.encoding) {\n      if (self.dests.length !== 0) {\n        console.error(\"Ingoring encoding parameter as this stream is being piped to another stream which makes the encoding option invalid.\");\n      } else {\n        response.setEncoding(self.encoding);\n      }\n    }\n\n    self.dests.forEach(function (dest) {\n      self.pipeDest(dest);\n    });\n    response.on(\"data\", function (chunk) {\n      self._destdata = true;\n      self.emit(\"data\", chunk);\n    });\n    response.on(\"end\", function (chunk) {\n      self._ended = true;\n      self.emit(\"end\", chunk);\n    });\n    response.on(\"close\", function () {\n      self.emit(\"close\");\n    });\n    self.emit('response', response);\n\n    if (self.callback) {\n      var buffer = [];\n      var bodyLen = 0;\n      self.on(\"data\", function (chunk) {\n        buffer.push(chunk);\n        bodyLen += chunk.length;\n      });\n      self.on(\"end\", function () {\n        debug('end event', self.uri.href);\n\n        if (self._aborted) {\n          debug('aborted', self.uri.href);\n          return;\n        }\n\n        if (buffer.length && Buffer.isBuffer(buffer[0])) {\n          debug('has body', self.uri.href, bodyLen);\n          var body = new Buffer(bodyLen);\n          var i = 0;\n          buffer.forEach(function (chunk) {\n            chunk.copy(body, i, 0, chunk.length);\n            i += chunk.length;\n          });\n\n          if (self.encoding === null) {\n            response.body = body;\n          } else {\n            response.body = body.toString(self.encoding);\n          }\n        } else if (buffer.length) {\n          // The UTF8 BOM [0xEF,0xBB,0xBF] is converted to [0xFE,0xFF] in the JS UTC16/UCS2 representation.\n          // Strip this value out when the encoding is set to 'utf8', as upstream consumers won't expect it and it breaks JSON.parse().\n          if (self.encoding === 'utf8' && buffer[0].length > 0 && buffer[0][0] === \"\\uFEFF\") {\n            buffer[0] = buffer[0].substring(1);\n          }\n\n          response.body = buffer.join('');\n        }\n\n        if (self._json) {\n          try {\n            response.body = JSON.parse(response.body);\n          } catch (e) {}\n        }\n\n        debug('emitting complete', self.uri.href);\n        self.emit('complete', response, response.body);\n      });\n    }\n  }\n\n  debug('finish init function', self.uri.href);\n};\n\nRequest.prototype.abort = function () {\n  this._aborted = true;\n\n  if (this.req) {\n    this.req.abort();\n  } else if (this.response) {\n    this.response.abort();\n  }\n\n  this.emit(\"abort\");\n};\n\nRequest.prototype.pipeDest = function (dest) {\n  var response = this.response; // Called after the response is received\n\n  if (dest.headers) {\n    dest.headers['content-type'] = response.headers['content-type'];\n\n    if (response.headers['content-length']) {\n      dest.headers['content-length'] = response.headers['content-length'];\n    }\n  }\n\n  if (dest.setHeader) {\n    for (var i in response.headers) {\n      dest.setHeader(i, response.headers[i]);\n    }\n\n    dest.statusCode = response.statusCode;\n  }\n\n  if (this.pipefilter) this.pipefilter(response, dest);\n}; // Composable API\n\n\nRequest.prototype.setHeader = function (name, value, clobber) {\n  if (clobber === undefined) clobber = true;\n  if (clobber || !this.headers.hasOwnProperty(name)) this.headers[name] = value;else this.headers[name] += ',' + value;\n  return this;\n};\n\nRequest.prototype.setHeaders = function (headers) {\n  for (var i in headers) {\n    this.setHeader(i, headers[i]);\n  }\n\n  return this;\n};\n\nRequest.prototype.qs = function (q, clobber) {\n  var base;\n  if (!clobber && this.uri.query) base = qs.parse(this.uri.query);else base = {};\n\n  for (var i in q) {\n    base[i] = q[i];\n  }\n\n  if (qs.stringify(base) === '') {\n    return this;\n  }\n\n  this.uri = url.parse(this.uri.href.split('?')[0] + '?' + qs.stringify(base));\n  this.url = this.uri;\n  return this;\n};\n\nRequest.prototype.form = function (form) {\n  if (form) {\n    this.headers['content-type'] = 'application/x-www-form-urlencoded; charset=utf-8';\n    this.body = qs.stringify(form).toString('utf8');\n    return this;\n  } // create form-data object\n\n\n  this._form = new FormData();\n  return this._form;\n};\n\nRequest.prototype.multipart = function (multipart) {\n  var self = this;\n  self.body = [];\n\n  if (!self.headers['content-type']) {\n    self.headers['content-type'] = 'multipart/related; boundary=' + self.boundary;\n  } else {\n    self.headers['content-type'] = self.headers['content-type'].split(';')[0] + '; boundary=' + self.boundary;\n  }\n\n  if (!multipart.forEach) throw new Error('Argument error, options.multipart.');\n\n  if (self.preambleCRLF) {\n    self.body.push(new Buffer('\\r\\n'));\n  }\n\n  multipart.forEach(function (part) {\n    var body = part.body;\n    if (body == null) throw Error('Body attribute missing in multipart.');\n    delete part.body;\n    var preamble = '--' + self.boundary + '\\r\\n';\n    Object.keys(part).forEach(function (key) {\n      preamble += key + ': ' + part[key] + '\\r\\n';\n    });\n    preamble += '\\r\\n';\n    self.body.push(new Buffer(preamble));\n    self.body.push(new Buffer(body));\n    self.body.push(new Buffer('\\r\\n'));\n  });\n  self.body.push(new Buffer('--' + self.boundary + '--'));\n  return self;\n};\n\nRequest.prototype.json = function (val) {\n  var self = this;\n\n  var setAcceptHeader = function () {\n    if (!self.headers['accept'] && !self.headers['Accept']) {\n      self.setHeader('accept', 'application/json');\n    }\n  };\n\n  setAcceptHeader();\n  this._json = true;\n\n  if (typeof val === 'boolean') {\n    if (typeof this.body === 'object') {\n      setAcceptHeader();\n      this.body = safeStringify(this.body);\n      self.setHeader('content-type', 'application/json');\n    }\n  } else {\n    setAcceptHeader();\n    this.body = safeStringify(val);\n    self.setHeader('content-type', 'application/json');\n  }\n\n  return this;\n};\n\nfunction getHeader(name, headers) {\n  var result, re, match;\n  Object.keys(headers).forEach(function (key) {\n    re = new RegExp(name, 'i');\n    match = key.match(re);\n    if (match) result = headers[key];\n  });\n  return result;\n}\n\nRequest.prototype.auth = function (user, pass, sendImmediately) {\n  if (typeof user !== 'string' || typeof pass !== 'string') {\n    throw new Error('auth() received invalid user or password');\n  }\n\n  this._user = user;\n  this._pass = pass;\n  this._hasAuth = true;\n\n  if (sendImmediately || typeof sendImmediately == 'undefined') {\n    this.setHeader('authorization', 'Basic ' + toBase64(user + ':' + pass));\n    this._sentAuth = true;\n  }\n\n  return this;\n};\n\nRequest.prototype.aws = function (opts, now) {\n  if (!now) {\n    this._aws = opts;\n    return this;\n  }\n\n  var date = new Date();\n  this.setHeader('date', date.toUTCString());\n  var auth = {\n    key: opts.key,\n    secret: opts.secret,\n    verb: this.method.toUpperCase(),\n    date: date,\n    contentType: getHeader('content-type', this.headers) || '',\n    md5: getHeader('content-md5', this.headers) || '',\n    amazonHeaders: aws.canonicalizeHeaders(this.headers)\n  };\n\n  if (opts.bucket && this.path) {\n    auth.resource = '/' + opts.bucket + this.path;\n  } else if (opts.bucket && !this.path) {\n    auth.resource = '/' + opts.bucket;\n  } else if (!opts.bucket && this.path) {\n    auth.resource = this.path;\n  } else if (!opts.bucket && !this.path) {\n    auth.resource = '/';\n  }\n\n  auth.resource = aws.canonicalizeResource(auth.resource);\n  this.setHeader('authorization', aws.authorization(auth));\n  return this;\n};\n\nRequest.prototype.hawk = function (opts) {\n  this.headers.Authorization = hawk.client.header(this.uri, this.method, opts).field;\n};\n\nRequest.prototype.oauth = function (_oauth) {\n  var form;\n\n  if (this.headers['content-type'] && this.headers['content-type'].slice(0, 'application/x-www-form-urlencoded'.length) === 'application/x-www-form-urlencoded') {\n    form = qs.parse(this.body);\n  }\n\n  if (this.uri.query) {\n    form = qs.parse(this.uri.query);\n  }\n\n  if (!form) form = {};\n  var oa = {};\n\n  for (var i in form) oa[i] = form[i];\n\n  for (var i in _oauth) oa['oauth_' + i] = _oauth[i];\n\n  if (!oa.oauth_version) oa.oauth_version = '1.0';\n  if (!oa.oauth_timestamp) oa.oauth_timestamp = Math.floor(Date.now() / 1000).toString();\n  if (!oa.oauth_nonce) oa.oauth_nonce = uuid().replace(/-/g, '');\n  oa.oauth_signature_method = 'HMAC-SHA1';\n  var consumer_secret = oa.oauth_consumer_secret;\n  delete oa.oauth_consumer_secret;\n  var token_secret = oa.oauth_token_secret;\n  delete oa.oauth_token_secret;\n  var timestamp = oa.oauth_timestamp;\n  var baseurl = this.uri.protocol + '//' + this.uri.host + this.uri.pathname;\n  var signature = oauth.hmacsign(this.method, baseurl, oa, consumer_secret, token_secret); // oa.oauth_signature = signature\n\n  for (var i in form) {\n    if (i.slice(0, 'oauth_') in _oauth) {// skip \n    } else {\n      delete oa['oauth_' + i];\n      if (i !== 'x_auth_mode') delete oa[i];\n    }\n  }\n\n  oa.oauth_timestamp = timestamp;\n  this.headers.Authorization = 'OAuth ' + Object.keys(oa).sort().map(function (i) {\n    return i + '=\"' + oauth.rfc3986(oa[i]) + '\"';\n  }).join(',');\n  this.headers.Authorization += ',oauth_signature=\"' + oauth.rfc3986(signature) + '\"';\n  return this;\n};\n\nRequest.prototype.jar = function (jar) {\n  var cookies;\n\n  if (this._redirectsFollowed === 0) {\n    this.originalCookieHeader = this.headers.cookie;\n  }\n\n  if (jar === false) {\n    // disable cookies\n    cookies = false;\n    this._disableCookies = true;\n  } else if (jar) {\n    // fetch cookie from the user defined cookie jar\n    cookies = jar.get({\n      url: this.uri.href\n    });\n  } else {\n    // fetch cookie from the global cookie jar\n    cookies = cookieJar.get({\n      url: this.uri.href\n    });\n  }\n\n  if (cookies && cookies.length) {\n    var cookieString = cookies.map(function (c) {\n      return c.name + \"=\" + c.value;\n    }).join(\"; \");\n\n    if (this.originalCookieHeader) {\n      // Don't overwrite existing Cookie header\n      this.headers.cookie = this.originalCookieHeader + '; ' + cookieString;\n    } else {\n      this.headers.cookie = cookieString;\n    }\n  }\n\n  this._jar = jar;\n  return this;\n}; // Stream API\n\n\nRequest.prototype.pipe = function (dest, opts) {\n  if (this.response) {\n    if (this._destdata) {\n      throw new Error(\"You cannot pipe after data has been emitted from the response.\");\n    } else if (this._ended) {\n      throw new Error(\"You cannot pipe after the response has been ended.\");\n    } else {\n      stream.Stream.prototype.pipe.call(this, dest, opts);\n      this.pipeDest(dest);\n      return dest;\n    }\n  } else {\n    this.dests.push(dest);\n    stream.Stream.prototype.pipe.call(this, dest, opts);\n    return dest;\n  }\n};\n\nRequest.prototype.write = function () {\n  if (!this._started) this.start();\n  return this.req.write.apply(this.req, arguments);\n};\n\nRequest.prototype.end = function (chunk) {\n  if (chunk) this.write(chunk);\n  if (!this._started) this.start();\n  this.req.end();\n};\n\nRequest.prototype.pause = function () {\n  if (!this.response) this._paused = true;else this.response.pause.apply(this.response, arguments);\n};\n\nRequest.prototype.resume = function () {\n  if (!this.response) this._paused = false;else this.response.resume.apply(this.response, arguments);\n};\n\nRequest.prototype.destroy = function () {\n  if (!this._ended) this.end();else if (this.response) this.response.destroy();\n}; // organize params for patch, post, put, head, del\n\n\nfunction initParams(uri, options, callback) {\n  if (typeof options === 'function' && !callback) callback = options;\n\n  if (options && typeof options === 'object') {\n    options.uri = uri;\n  } else if (typeof uri === 'string') {\n    options = {\n      uri: uri\n    };\n  } else {\n    options = uri;\n    uri = options.uri;\n  }\n\n  return {\n    uri: uri,\n    options: options,\n    callback: callback\n  };\n}\n\nfunction request(uri, options, callback) {\n  if (typeof uri === 'undefined') throw new Error('undefined is not a valid uri or options object.');\n  if (typeof options === 'function' && !callback) callback = options;\n\n  if (options && typeof options === 'object') {\n    options.uri = uri;\n  } else if (typeof uri === 'string') {\n    options = {\n      uri: uri\n    };\n  } else {\n    options = uri;\n  }\n\n  options = copy(options);\n  if (callback) options.callback = callback;\n  var r = new Request(options);\n  return r;\n}\n\nmodule.exports = request;\nrequest.debug = process.env.NODE_DEBUG && /request/.test(process.env.NODE_DEBUG);\nrequest.initParams = initParams;\n\nrequest.defaults = function (options, requester) {\n  var def = function (method) {\n    var d = function (uri, opts, callback) {\n      var params = initParams(uri, opts, callback);\n\n      for (var i in options) {\n        if (params.options[i] === undefined) params.options[i] = options[i];\n      }\n\n      if (typeof requester === 'function') {\n        if (method === request) {\n          method = requester;\n        } else {\n          params.options._requester = requester;\n        }\n      }\n\n      return method(params.options, params.callback);\n    };\n\n    return d;\n  };\n\n  var de = def(request);\n  de.get = def(request.get);\n  de.patch = def(request.patch);\n  de.post = def(request.post);\n  de.put = def(request.put);\n  de.head = def(request.head);\n  de.del = def(request.del);\n  de.cookie = def(request.cookie);\n  de.jar = request.jar;\n  return de;\n};\n\nrequest.forever = function (agentOptions, optionsArg) {\n  var options = {};\n\n  if (optionsArg) {\n    for (option in optionsArg) {\n      options[option] = optionsArg[option];\n    }\n  }\n\n  if (agentOptions) options.agentOptions = agentOptions;\n  options.forever = true;\n  return request.defaults(options);\n};\n\nrequest.get = request;\n\nrequest.post = function (uri, options, callback) {\n  var params = initParams(uri, options, callback);\n  params.options.method = 'POST';\n  return request(params.uri || null, params.options, params.callback);\n};\n\nrequest.put = function (uri, options, callback) {\n  var params = initParams(uri, options, callback);\n  params.options.method = 'PUT';\n  return request(params.uri || null, params.options, params.callback);\n};\n\nrequest.patch = function (uri, options, callback) {\n  var params = initParams(uri, options, callback);\n  params.options.method = 'PATCH';\n  return request(params.uri || null, params.options, params.callback);\n};\n\nrequest.head = function (uri, options, callback) {\n  var params = initParams(uri, options, callback);\n  params.options.method = 'HEAD';\n\n  if (params.options.body || params.options.requestBodyStream || params.options.json && typeof params.options.json !== 'boolean' || params.options.multipart) {\n    throw new Error(\"HTTP HEAD requests MUST NOT include a request body.\");\n  }\n\n  return request(params.uri || null, params.options, params.callback);\n};\n\nrequest.del = function (uri, options, callback) {\n  var params = initParams(uri, options, callback);\n  params.options.method = 'DELETE';\n\n  if (typeof params.options._requester === 'function') {\n    request = params.options._requester;\n  }\n\n  return request(params.uri || null, params.options, params.callback);\n};\n\nrequest.jar = function () {\n  return new CookieJar();\n};\n\nrequest.cookie = function (str) {\n  if (str && str.uri) str = str.uri;\n  if (typeof str !== 'string') throw new Error(\"The cookie function only accepts STRING as param\");\n  return new Cookie(str);\n}; // Safe toJSON\n\n\nfunction getSafe(self, uuid) {\n  if (typeof self === 'object' || typeof self === 'function') var safe = {};\n  if (Array.isArray(self)) var safe = [];\n  var recurse = [];\n  Object.defineProperty(self, uuid, {});\n  var attrs = Object.keys(self).filter(function (i) {\n    if (i === uuid) return false;\n    if (typeof self[i] !== 'object' && typeof self[i] !== 'function' || self[i] === null) return true;\n    return !Object.getOwnPropertyDescriptor(self[i], uuid);\n  });\n\n  for (var i = 0; i < attrs.length; i++) {\n    if (typeof self[attrs[i]] !== 'object' && typeof self[attrs[i]] !== 'function' || self[attrs[i]] === null) {\n      safe[attrs[i]] = self[attrs[i]];\n    } else {\n      recurse.push(attrs[i]);\n      Object.defineProperty(self[attrs[i]], uuid, {});\n    }\n  }\n\n  for (var i = 0; i < recurse.length; i++) {\n    safe[recurse[i]] = getSafe(self[recurse[i]], uuid);\n  }\n\n  return safe;\n}\n\nfunction toJSON() {\n  return getSafe(this, '__' + ((1 + Math.random()) * 0x10000 | 0).toString(16));\n}\n\nRequest.prototype.toJSON = toJSON;","map":{"version":3,"sources":["C:/react/quiz/node_modules/request/index.js"],"names":["http","require","https","tls","url","util","stream","qs","querystring","crypto","oauth","hawk","aws","uuid","mime","tunnel","safeStringify","ForeverAgent","FormData","Cookie","CookieJar","Jar","cookieJar","e","debug","test","process","env","NODE_DEBUG","console","error","format","apply","arguments","toBase64","str","Buffer","toString","md5","createHash","update","digest","Agent","options","call","inherits","prototype","_getConnection","host","port","cb","s","connect","isReadStream","rs","readable","path","mode","copy","obj","o","Object","keys","forEach","i","isUrl","globalPool","Request","Stream","writable","uri","reserved","indexOf","init","self","method","pool","dests","__isRequestRequest","_callback","callback","_callbackCalled","on","bind","emit","Error","parse","proxy","globalAgent","protocol","tunnelFn","httpsOverHttp","httpsOverHttps","tunnelOptions","hostname","proxyAuth","auth","headers","Host","ca","agent","pathname","faultyUri","message","length","_redirectsFollowed","maxRedirects","undefined","followRedirect","followAllRedirects","redirects","setHost","jar","_jar","clientErrorHandler","_aborted","req","_reusedSocket","code","addRequestNoreuse","addRequest","start","end","timeout","timeoutTimer","clearTimeout","_parserErrorHandler","res","request","_httpMessage","form","search","user","username","pass","password","sendImmediately","authorization","authPieces","split","map","item","unescape","join","json","multipart","boundary","body","isBuffer","Array","isArray","defaultModules","httpModules","httpModule","agentOptions","agentClass","forever","SSL","strictSSL","rejectUnauthorized","getAgent","maxSockets","once","src","ntick","_started","lookup","_json","nextTick","_form","setHeaders","getHeaders","pipe","part","write","requestBodyStream","warn","_updateProtocol","cert","key","poolKey","name","isHttps","href","stat","size","_aws","reqOptions","onResponse","setTimeout","abort","connection","removeListener","response","statusCode","listeners","resume","_paused","pause","toJSON","client","authorized","sslErr","authorizationError","addCookie","cookie","add","_disableCookies","redirectTo","location","_hasAuth","_sentAuth","authHeader","authVerb","_user","_pass","matches","match","challenge","eqPos","substring","quotedValue","ha1","realm","ha2","digestResponse","nonce","authValues","qop","nc","cnonce","k","push","setHeader","resolve","uriPrev","redirectUri","_ended","encoding","setEncoding","dest","pipeDest","chunk","_destdata","buffer","bodyLen","JSON","pipefilter","value","clobber","hasOwnProperty","q","base","query","stringify","preambleCRLF","preamble","val","setAcceptHeader","getHeader","result","re","RegExp","opts","now","date","Date","toUTCString","secret","verb","toUpperCase","contentType","amazonHeaders","canonicalizeHeaders","bucket","resource","canonicalizeResource","Authorization","header","field","_oauth","slice","oa","oauth_version","oauth_timestamp","Math","floor","oauth_nonce","replace","oauth_signature_method","consumer_secret","oauth_consumer_secret","token_secret","oauth_token_secret","timestamp","baseurl","signature","hmacsign","sort","rfc3986","cookies","originalCookieHeader","get","cookieString","c","destroy","initParams","r","module","exports","defaults","requester","def","d","params","_requester","de","patch","post","put","head","del","optionsArg","option","getSafe","safe","recurse","defineProperty","attrs","filter","getOwnPropertyDescriptor","random"],"mappings":"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","sourcesContent":["// Copyright 2010-2012 Mikeal Rogers\n//\n//    Licensed under the Apache License, Version 2.0 (the \"License\");\n//    you may not use this file except in compliance with the License.\n//    You may obtain a copy of the License at\n//\n//        http://www.apache.org/licenses/LICENSE-2.0\n//\n//    Unless required by applicable law or agreed to in writing, software\n//    distributed under the License is distributed on an \"AS IS\" BASIS,\n//    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n//    See the License for the specific language governing permissions and\n//    limitations under the License.\n\nvar http = require('http')\n  , https = false\n  , tls = false\n  , url = require('url')\n  , util = require('util')\n  , stream = require('stream')\n  , qs = require('qs')\n  , querystring = require('querystring')\n  , crypto = require('crypto')\n  \n  , oauth = require('oauth-sign')\n  , hawk = require('hawk')\n  , aws = require('aws-sign')\n  , uuid = require('node-uuid')\n  , mime = require('mime')\n  , tunnel = require('tunnel-agent')\n  , safeStringify = require('json-stringify-safe')\n\n  , ForeverAgent = require('forever-agent')\n  , FormData = require('form-data')\n  \n  , Cookie = require('cookie-jar')\n  , CookieJar = Cookie.Jar\n  , cookieJar = new CookieJar\n  ;\n\ntry {\n  https = require('https')\n} catch (e) {}\n\ntry {\n  tls = require('tls')\n} catch (e) {}\n\nvar debug\nif (/\\brequest\\b/.test(process.env.NODE_DEBUG)) {\n  debug = function() {\n    console.error('REQUEST %s', util.format.apply(util, arguments))\n  }\n} else {\n  debug = function() {}\n}\n\nfunction toBase64 (str) {\n  return (new Buffer(str || \"\", \"ascii\")).toString(\"base64\")\n}\n\nfunction md5 (str) {\n  return crypto.createHash('md5').update(str).digest('hex')\n}\n\n// Hacky fix for pre-0.4.4 https\nif (https && !https.Agent) {\n  https.Agent = function (options) {\n    http.Agent.call(this, options)\n  }\n  util.inherits(https.Agent, http.Agent)\n  https.Agent.prototype._getConnection = function (host, port, cb) {\n    var s = tls.connect(port, host, this.options, function () {\n      // do other checks here?\n      if (cb) cb()\n    })\n    return s\n  }\n}\n\nfunction isReadStream (rs) {\n  if (rs.readable && rs.path && rs.mode) {\n    return true\n  }\n}\n\nfunction copy (obj) {\n  var o = {}\n  Object.keys(obj).forEach(function (i) {\n    o[i] = obj[i]\n  })\n  return o\n}\n\nvar isUrl = /^https?:/\n\nvar globalPool = {}\n\nfunction Request (options) {\n  stream.Stream.call(this)\n  this.readable = true\n  this.writable = true\n\n  if (typeof options === 'string') {\n    options = {uri:options}\n  }\n  \n  var reserved = Object.keys(Request.prototype)\n  for (var i in options) {\n    if (reserved.indexOf(i) === -1) {\n      this[i] = options[i]\n    } else {\n      if (typeof options[i] === 'function') {\n        delete options[i]\n      }\n    }\n  }\n  \n  this.init(options)\n}\nutil.inherits(Request, stream.Stream)\nRequest.prototype.init = function (options) {\n  // init() contains all the code to setup the request object.\n  // the actual outgoing request is not started until start() is called\n  // this function is called from both the constructor and on redirect.\n  var self = this\n  if (!options) options = {}\n  \n  self.method = options.method || 'GET'\n  \n  debug(options)\n  if (!self.pool && self.pool !== false) self.pool = globalPool\n  self.dests = self.dests || []\n  self.__isRequestRequest = true\n  \n  // Protect against double callback\n  if (!self._callback && self.callback) {\n    self._callback = self.callback\n    self.callback = function () {\n      if (self._callbackCalled) return // Print a warning maybe?\n      self._callbackCalled = true\n      self._callback.apply(self, arguments)\n    }\n    self.on('error', self.callback.bind())\n    self.on('complete', self.callback.bind(self, null))\n  }\n\n  if (self.url) {\n    // People use this property instead all the time so why not just support it.\n    self.uri = self.url\n    delete self.url\n  }\n\n  if (!self.uri) {\n    // this will throw if unhandled but is handleable when in a redirect\n    return self.emit('error', new Error(\"options.uri is a required argument\"))\n  } else {\n    if (typeof self.uri == \"string\") self.uri = url.parse(self.uri)\n  }\n  \n  if (self.proxy) {\n    if (typeof self.proxy == 'string') self.proxy = url.parse(self.proxy)\n\n    // do the HTTP CONNECT dance using koichik/node-tunnel\n    if (http.globalAgent && self.uri.protocol === \"https:\") {\n      var tunnelFn = self.proxy.protocol === \"http:\"\n                   ? tunnel.httpsOverHttp : tunnel.httpsOverHttps\n\n      var tunnelOptions = { proxy: { host: self.proxy.hostname\n                                   , port: +self.proxy.port\n                                   , proxyAuth: self.proxy.auth\n                                   , headers: { Host: self.uri.hostname + ':' + \n                                        (self.uri.port || self.uri.protocol === 'https:' ? 443 : 80) }}\n                          , ca: this.ca }\n\n      self.agent = tunnelFn(tunnelOptions)\n      self.tunnel = true\n    }\n  }\n\n  if (!self.uri.host || !self.uri.pathname) {\n    // Invalid URI: it may generate lot of bad errors, like \"TypeError: Cannot call method 'indexOf' of undefined\" in CookieJar\n    // Detect and reject it as soon as possible\n    var faultyUri = url.format(self.uri)\n    var message = 'Invalid URI \"' + faultyUri + '\"'\n    if (Object.keys(options).length === 0) {\n      // No option ? This can be the sign of a redirect\n      // As this is a case where the user cannot do anything (he didn't call request directly with this URL)\n      // he should be warned that it can be caused by a redirection (can save some hair)\n      message += '. This can be caused by a crappy redirection.'\n    }\n    self.emit('error', new Error(message))\n    return // This error was fatal\n  }\n\n  self._redirectsFollowed = self._redirectsFollowed || 0\n  self.maxRedirects = (self.maxRedirects !== undefined) ? self.maxRedirects : 10\n  self.followRedirect = (self.followRedirect !== undefined) ? self.followRedirect : true\n  self.followAllRedirects = (self.followAllRedirects !== undefined) ? self.followAllRedirects : false\n  if (self.followRedirect || self.followAllRedirects)\n    self.redirects = self.redirects || []\n\n  self.headers = self.headers ? copy(self.headers) : {}\n\n  self.setHost = false\n  if (!(self.headers.host || self.headers.Host)) {\n    self.headers.host = self.uri.hostname\n    if (self.uri.port) {\n      if ( !(self.uri.port === 80 && self.uri.protocol === 'http:') &&\n           !(self.uri.port === 443 && self.uri.protocol === 'https:') )\n      self.headers.host += (':'+self.uri.port)\n    }\n    self.setHost = true\n  }\n  \n  self.jar(self._jar || options.jar)\n\n  if (!self.uri.pathname) {self.uri.pathname = '/'}\n  if (!self.uri.port) {\n    if (self.uri.protocol == 'http:') {self.uri.port = 80}\n    else if (self.uri.protocol == 'https:') {self.uri.port = 443}\n  }\n\n  if (self.proxy && !self.tunnel) {\n    self.port = self.proxy.port\n    self.host = self.proxy.hostname\n  } else {\n    self.port = self.uri.port\n    self.host = self.uri.hostname\n  }\n\n  self.clientErrorHandler = function (error) {\n    if (self._aborted) return\n    \n    if (self.req && self.req._reusedSocket && error.code === 'ECONNRESET'\n        && self.agent.addRequestNoreuse) {\n      self.agent = { addRequest: self.agent.addRequestNoreuse.bind(self.agent) }\n      self.start()\n      self.req.end()\n      return\n    }\n    if (self.timeout && self.timeoutTimer) {\n      clearTimeout(self.timeoutTimer)\n      self.timeoutTimer = null\n    }\n    self.emit('error', error)\n  }\n\n  self._parserErrorHandler = function (error) {\n    if (this.res) {\n      if (this.res.request) {\n        this.res.request.emit('error', error)\n      } else {\n        this.res.emit('error', error)\n      }\n    } else {\n      this._httpMessage.emit('error', error)\n    }\n  }\n\n  if (options.form) {\n    self.form(options.form)\n  }\n  \n  if (options.qs) self.qs(options.qs)\n\n  if (self.uri.path) {\n    self.path = self.uri.path\n  } else {\n    self.path = self.uri.pathname + (self.uri.search || \"\")\n  }\n\n  if (self.path.length === 0) self.path = '/'\n\n\n  // Auth must happen last in case signing is dependent on other headers\n  if (options.oauth) {\n    self.oauth(options.oauth)\n  }\n  \n  if (options.aws) {\n    self.aws(options.aws)\n  }\n  \n  if (options.hawk) {\n    self.hawk(options.hawk)\n  }\n\n  if (options.auth) {\n    self.auth(\n      options.auth.user || options.auth.username,\n      options.auth.pass || options.auth.password,\n      options.auth.sendImmediately)\n  }\n\n  if (self.uri.auth && !self.headers.authorization) {\n    var authPieces = self.uri.auth.split(':').map(function(item){ return querystring.unescape(item) })\n    self.auth(authPieces[0], authPieces[1], true)\n  }\n  if (self.proxy && self.proxy.auth && !self.headers['proxy-authorization'] && !self.tunnel) {\n    self.headers['proxy-authorization'] = \"Basic \" + toBase64(self.proxy.auth.split(':').map(function(item){ return querystring.unescape(item)}).join(':'))\n  }\n\n  \n  if (self.proxy && !self.tunnel) self.path = (self.uri.protocol + '//' + self.uri.host + self.path)\n\n  if (options.json) {\n    self.json(options.json)\n  } else if (options.multipart) {\n    self.boundary = uuid()\n    self.multipart(options.multipart)\n  }\n\n  if (self.body) {\n    var length = 0\n    if (!Buffer.isBuffer(self.body)) {\n      if (Array.isArray(self.body)) {\n        for (var i = 0; i < self.body.length; i++) {\n          length += self.body[i].length\n        }\n      } else {\n        self.body = new Buffer(self.body)\n        length = self.body.length\n      }\n    } else {\n      length = self.body.length\n    }\n    if (length) {\n      if(!self.headers['content-length'] && !self.headers['Content-Length'])\n      self.headers['content-length'] = length\n    } else {\n      throw new Error('Argument error, options.body.')\n    }\n  }\n\n  var protocol = self.proxy && !self.tunnel ? self.proxy.protocol : self.uri.protocol\n    , defaultModules = {'http:':http, 'https:':https}\n    , httpModules = self.httpModules || {}\n    ;\n  self.httpModule = httpModules[protocol] || defaultModules[protocol]\n\n  if (!self.httpModule) return this.emit('error', new Error(\"Invalid protocol\"))\n\n  if (options.ca) self.ca = options.ca\n\n  if (!self.agent) {\n    if (options.agentOptions) self.agentOptions = options.agentOptions\n\n    if (options.agentClass) {\n      self.agentClass = options.agentClass\n    } else if (options.forever) {\n      self.agentClass = protocol === 'http:' ? ForeverAgent : ForeverAgent.SSL\n    } else {\n      self.agentClass = self.httpModule.Agent\n    }\n  }\n  \n  if (self.strictSSL === false) {\n    self.rejectUnauthorized = false\n  }\n\n  if (self.pool === false) {\n    self.agent = false\n  } else {\n    self.agent = self.agent || self.getAgent()\n    if (self.maxSockets) {\n      // Don't use our pooling if node has the refactored client\n      self.agent.maxSockets = self.maxSockets\n    }\n    if (self.pool.maxSockets) {\n      // Don't use our pooling if node has the refactored client\n      self.agent.maxSockets = self.pool.maxSockets\n    }\n  }\n\n  self.once('pipe', function (src) {\n    if (self.ntick && self._started) throw new Error(\"You cannot pipe to this stream after the outbound request has started.\")\n    self.src = src\n    if (isReadStream(src)) {\n      if (!self.headers['content-type'] && !self.headers['Content-Type'])\n        self.headers['content-type'] = mime.lookup(src.path)\n    } else {\n      if (src.headers) {\n        for (var i in src.headers) {\n          if (!self.headers[i]) {\n            self.headers[i] = src.headers[i]\n          }\n        }\n      }\n      if (self._json && !self.headers['content-type'] && !self.headers['Content-Type'])\n        self.headers['content-type'] = 'application/json'\n      if (src.method && !self.method) {\n        self.method = src.method\n      }\n    }\n\n    self.on('pipe', function () {\n      console.error(\"You have already piped to this stream. Pipeing twice is likely to break the request.\")\n    })\n  })\n\n  process.nextTick(function () {\n    if (self._aborted) return\n    \n    if (self._form) {\n      self.setHeaders(self._form.getHeaders())\n      self._form.pipe(self)\n    }\n    if (self.body) {\n      if (Array.isArray(self.body)) {\n        self.body.forEach(function (part) {\n          self.write(part)\n        })\n      } else {\n        self.write(self.body)\n      }\n      self.end()\n    } else if (self.requestBodyStream) {\n      console.warn(\"options.requestBodyStream is deprecated, please pass the request object to stream.pipe.\")\n      self.requestBodyStream.pipe(self)\n    } else if (!self.src) {\n      if (self.method !== 'GET' && typeof self.method !== 'undefined') {\n        self.headers['content-length'] = 0\n      }\n      self.end()\n    }\n    self.ntick = true\n  })\n}\n\n// Must call this when following a redirect from https to http or vice versa\n// Attempts to keep everything as identical as possible, but update the\n// httpModule, Tunneling agent, and/or Forever Agent in use.\nRequest.prototype._updateProtocol = function () {\n  var self = this\n  var protocol = self.uri.protocol\n\n  if (protocol === 'https:') {\n    // previously was doing http, now doing https\n    // if it's https, then we might need to tunnel now.\n    if (self.proxy) {\n      self.tunnel = true\n      var tunnelFn = self.proxy.protocol === 'http:'\n                   ? tunnel.httpsOverHttp : tunnel.httpsOverHttps\n      var tunnelOptions = { proxy: { host: self.proxy.hostname\n                                   , port: +self.proxy.port\n                                   , proxyAuth: self.proxy.auth }\n                          , ca: self.ca }\n      self.agent = tunnelFn(tunnelOptions)\n      return\n    }\n\n    self.httpModule = https\n    switch (self.agentClass) {\n      case ForeverAgent:\n        self.agentClass = ForeverAgent.SSL\n        break\n      case http.Agent:\n        self.agentClass = https.Agent\n        break\n      default:\n        // nothing we can do.  Just hope for the best.\n        return\n    }\n\n    // if there's an agent, we need to get a new one.\n    if (self.agent) self.agent = self.getAgent()\n\n  } else {\n    // previously was doing https, now doing http\n    // stop any tunneling.\n    if (self.tunnel) self.tunnel = false\n    self.httpModule = http\n    switch (self.agentClass) {\n      case ForeverAgent.SSL:\n        self.agentClass = ForeverAgent\n        break\n      case https.Agent:\n        self.agentClass = http.Agent\n        break\n      default:\n        // nothing we can do.  just hope for the best\n        return\n    }\n\n    // if there's an agent, then get a new one.\n    if (self.agent) {\n      self.agent = null\n      self.agent = self.getAgent()\n    }\n  }\n}\n\nRequest.prototype.getAgent = function () {\n  var Agent = this.agentClass\n  var options = {}\n  if (this.agentOptions) {\n    for (var i in this.agentOptions) {\n      options[i] = this.agentOptions[i]\n    }\n  }\n  if (this.ca) options.ca = this.ca\n  if (typeof this.rejectUnauthorized !== 'undefined') options.rejectUnauthorized = this.rejectUnauthorized\n\n  if (this.cert && this.key) {\n    options.key = this.key\n    options.cert = this.cert\n  }\n\n  var poolKey = ''\n\n  // different types of agents are in different pools\n  if (Agent !== this.httpModule.Agent) {\n    poolKey += Agent.name\n  }\n\n  if (!this.httpModule.globalAgent) {\n    // node 0.4.x\n    options.host = this.host\n    options.port = this.port\n    if (poolKey) poolKey += ':'\n    poolKey += this.host + ':' + this.port\n  }\n\n  // ca option is only relevant if proxy or destination are https\n  var proxy = this.proxy\n  if (typeof proxy === 'string') proxy = url.parse(proxy)\n  var isHttps = (proxy && proxy.protocol === 'https:') || this.uri.protocol === 'https:'\n  if (isHttps) {\n    if (options.ca) {\n      if (poolKey) poolKey += ':'\n      poolKey += options.ca\n    }\n\n    if (typeof options.rejectUnauthorized !== 'undefined') {\n      if (poolKey) poolKey += ':'\n      poolKey += options.rejectUnauthorized\n    }\n\n    if (options.cert)\n      poolKey += options.cert.toString('ascii') + options.key.toString('ascii')\n  }\n\n  if (!poolKey && Agent === this.httpModule.Agent && this.httpModule.globalAgent) {\n    // not doing anything special.  Use the globalAgent\n    return this.httpModule.globalAgent\n  }\n\n  // we're using a stored agent.  Make sure it's protocol-specific\n  poolKey = this.uri.protocol + poolKey\n\n  // already generated an agent for this setting\n  if (this.pool[poolKey]) return this.pool[poolKey]\n\n  return this.pool[poolKey] = new Agent(options)\n}\n\nRequest.prototype.start = function () {\n  // start() is called once we are ready to send the outgoing HTTP request.\n  // this is usually called on the first write(), end() or on nextTick()\n  var self = this\n\n  if (self._aborted) return\n\n  self._started = true\n  self.method = self.method || 'GET'\n  self.href = self.uri.href\n\n  if (self.src && self.src.stat && self.src.stat.size && !self.headers['content-length'] && !self.headers['Content-Length']) {\n    self.headers['content-length'] = self.src.stat.size\n  }\n  if (self._aws) {\n    self.aws(self._aws, true)\n  }\n\n  // We have a method named auth, which is completely different from the http.request\n  // auth option.  If we don't remove it, we're gonna have a bad time.\n  var reqOptions = copy(self)\n  delete reqOptions.auth\n\n  debug('make request', self.uri.href)\n  self.req = self.httpModule.request(reqOptions, self.onResponse.bind(self))\n\n  if (self.timeout && !self.timeoutTimer) {\n    self.timeoutTimer = setTimeout(function () {\n      self.req.abort()\n      var e = new Error(\"ETIMEDOUT\")\n      e.code = \"ETIMEDOUT\"\n      self.emit(\"error\", e)\n    }, self.timeout)\n    \n    // Set additional timeout on socket - in case if remote\n    // server freeze after sending headers\n    if (self.req.setTimeout) { // only works on node 0.6+\n      self.req.setTimeout(self.timeout, function () {\n        if (self.req) {\n          self.req.abort()\n          var e = new Error(\"ESOCKETTIMEDOUT\")\n          e.code = \"ESOCKETTIMEDOUT\"\n          self.emit(\"error\", e)\n        }\n      })\n    }\n  }\n  \n  self.req.on('error', self.clientErrorHandler)\n  self.req.on('drain', function() {\n    self.emit('drain')\n  })\n  self.on('end', function() {\n    if ( self.req.connection ) self.req.connection.removeListener('error', self._parserErrorHandler)\n  })\n  self.emit('request', self.req)\n}\nRequest.prototype.onResponse = function (response) {\n  var self = this\n  debug('onResponse', self.uri.href, response.statusCode, response.headers)\n  response.on('end', function() {\n    debug('response end', self.uri.href, response.statusCode, response.headers)\n  });\n  \n  if (response.connection.listeners('error').indexOf(self._parserErrorHandler) === -1) {\n    response.connection.once('error', self._parserErrorHandler)\n  }\n  if (self._aborted) {\n    debug('aborted', self.uri.href)\n    response.resume()\n    return\n  }\n  if (self._paused) response.pause()\n  else response.resume()\n\n  self.response = response\n  response.request = self\n  response.toJSON = toJSON\n\n  // XXX This is different on 0.10, because SSL is strict by default\n  if (self.httpModule === https &&\n      self.strictSSL &&\n      !response.client.authorized) {\n    debug('strict ssl error', self.uri.href)\n    var sslErr = response.client.authorizationError\n    self.emit('error', new Error('SSL Error: '+ sslErr))\n    return\n  }\n\n  if (self.setHost) delete self.headers.host\n  if (self.timeout && self.timeoutTimer) {\n    clearTimeout(self.timeoutTimer)\n    self.timeoutTimer = null\n  }\n\n  var addCookie = function (cookie) {\n    if (self._jar) self._jar.add(new Cookie(cookie))\n    else cookieJar.add(new Cookie(cookie))\n  }\n\n  if (response.headers['set-cookie'] && (!self._disableCookies)) {\n    if (Array.isArray(response.headers['set-cookie'])) response.headers['set-cookie'].forEach(addCookie)\n    else addCookie(response.headers['set-cookie'])\n  }\n\n  var redirectTo = null\n  if (response.statusCode >= 300 && response.statusCode < 400 && response.headers.location) {\n    debug('redirect', response.headers.location)\n\n    if (self.followAllRedirects) {\n      redirectTo = response.headers.location\n    } else if (self.followRedirect) {\n      switch (self.method) {\n        case 'PATCH':\n        case 'PUT':\n        case 'POST':\n        case 'DELETE':\n          // Do not follow redirects\n          break\n        default:\n          redirectTo = response.headers.location\n          break\n      }\n    }\n  } else if (response.statusCode == 401 && self._hasAuth && !self._sentAuth) {\n    var authHeader = response.headers['www-authenticate']\n    var authVerb = authHeader && authHeader.split(' ')[0]\n    debug('reauth', authVerb)\n\n    switch (authVerb) {\n      case 'Basic':\n        self.auth(self._user, self._pass, true)\n        redirectTo = self.uri\n        break\n\n      case 'Digest':\n        // TODO: More complete implementation of RFC 2617.  For reference:\n        // http://tools.ietf.org/html/rfc2617#section-3\n        // https://github.com/bagder/curl/blob/master/lib/http_digest.c\n\n        var matches = authHeader.match(/([a-z0-9_-]+)=\"([^\"]+)\"/gi)\n        var challenge = {}\n\n        for (var i = 0; i < matches.length; i++) {\n          var eqPos = matches[i].indexOf('=')\n          var key = matches[i].substring(0, eqPos)\n          var quotedValue = matches[i].substring(eqPos + 1)\n          challenge[key] = quotedValue.substring(1, quotedValue.length - 1)\n        }\n\n        var ha1 = md5(self._user + ':' + challenge.realm + ':' + self._pass)\n        var ha2 = md5(self.method + ':' + self.uri.path)\n        var digestResponse = md5(ha1 + ':' + challenge.nonce + ':1::auth:' + ha2)\n        var authValues = {\n          username: self._user,\n          realm: challenge.realm,\n          nonce: challenge.nonce,\n          uri: self.uri.path,\n          qop: challenge.qop,\n          response: digestResponse,\n          nc: 1,\n          cnonce: ''\n        }\n\n        authHeader = []\n        for (var k in authValues) {\n          authHeader.push(k + '=\"' + authValues[k] + '\"')\n        }\n        authHeader = 'Digest ' + authHeader.join(', ')\n        self.setHeader('authorization', authHeader)\n        self._sentAuth = true\n\n        redirectTo = self.uri\n        break\n    }\n  }\n\n  if (redirectTo) {\n    debug('redirect to', redirectTo)\n\n    // ignore any potential response body.  it cannot possibly be useful\n    // to us at this point.\n    if (self._paused) response.resume()\n\n    if (self._redirectsFollowed >= self.maxRedirects) {\n      self.emit('error', new Error(\"Exceeded maxRedirects. Probably stuck in a redirect loop \"+self.uri.href))\n      return\n    }\n    self._redirectsFollowed += 1\n\n    if (!isUrl.test(redirectTo)) {\n      redirectTo = url.resolve(self.uri.href, redirectTo)\n    }\n\n    var uriPrev = self.uri\n    self.uri = url.parse(redirectTo)\n\n    // handle the case where we change protocol from https to http or vice versa\n    if (self.uri.protocol !== uriPrev.protocol) {\n      self._updateProtocol()\n    }\n\n    self.redirects.push(\n      { statusCode : response.statusCode\n      , redirectUri: redirectTo\n      }\n    )\n    if (self.followAllRedirects && response.statusCode != 401) self.method = 'GET'\n    // self.method = 'GET' // Force all redirects to use GET || commented out fixes #215\n    delete self.src\n    delete self.req\n    delete self.agent\n    delete self._started\n    if (response.statusCode != 401) {\n      delete self.body\n      delete self._form\n    }\n    if (self.headers) {\n      delete self.headers.host\n      delete self.headers['content-type']\n      delete self.headers['content-length']\n    }\n    self.init()\n    return // Ignore the rest of the response\n  } else {\n    self._redirectsFollowed = self._redirectsFollowed || 0\n    // Be a good stream and emit end when the response is finished.\n    // Hack to emit end on close because of a core bug that never fires end\n    response.on('close', function () {\n      if (!self._ended) self.response.emit('end')\n    })\n\n    if (self.encoding) {\n      if (self.dests.length !== 0) {\n        console.error(\"Ingoring encoding parameter as this stream is being piped to another stream which makes the encoding option invalid.\")\n      } else {\n        response.setEncoding(self.encoding)\n      }\n    }\n\n    self.dests.forEach(function (dest) {\n      self.pipeDest(dest)\n    })\n\n    response.on(\"data\", function (chunk) {\n      self._destdata = true\n      self.emit(\"data\", chunk)\n    })\n    response.on(\"end\", function (chunk) {\n      self._ended = true\n      self.emit(\"end\", chunk)\n    })\n    response.on(\"close\", function () {self.emit(\"close\")})\n\n    self.emit('response', response)\n\n    if (self.callback) {\n      var buffer = []\n      var bodyLen = 0\n      self.on(\"data\", function (chunk) {\n        buffer.push(chunk)\n        bodyLen += chunk.length\n      })\n      self.on(\"end\", function () {\n        debug('end event', self.uri.href)\n        if (self._aborted) {\n          debug('aborted', self.uri.href)\n          return\n        }\n\n        if (buffer.length && Buffer.isBuffer(buffer[0])) {\n          debug('has body', self.uri.href, bodyLen)\n          var body = new Buffer(bodyLen)\n          var i = 0\n          buffer.forEach(function (chunk) {\n            chunk.copy(body, i, 0, chunk.length)\n            i += chunk.length\n          })\n          if (self.encoding === null) {\n            response.body = body\n          } else {\n            response.body = body.toString(self.encoding)\n          }\n        } else if (buffer.length) {\n          // The UTF8 BOM [0xEF,0xBB,0xBF] is converted to [0xFE,0xFF] in the JS UTC16/UCS2 representation.\n          // Strip this value out when the encoding is set to 'utf8', as upstream consumers won't expect it and it breaks JSON.parse().\n          if (self.encoding === 'utf8' && buffer[0].length > 0 && buffer[0][0] === \"\\uFEFF\") {\n            buffer[0] = buffer[0].substring(1)\n          }\n          response.body = buffer.join('')\n        }\n\n        if (self._json) {\n          try {\n            response.body = JSON.parse(response.body)\n          } catch (e) {}\n        }\n        debug('emitting complete', self.uri.href)\n        self.emit('complete', response, response.body)\n      })\n    }\n  }\n  debug('finish init function', self.uri.href)\n}\n\nRequest.prototype.abort = function () {\n  this._aborted = true\n  \n  if (this.req) {\n    this.req.abort()\n  }\n  else if (this.response) {\n    this.response.abort()\n  }\n  \n  this.emit(\"abort\")\n}\n\nRequest.prototype.pipeDest = function (dest) {\n  var response = this.response\n  // Called after the response is received\n  if (dest.headers) {\n    dest.headers['content-type'] = response.headers['content-type']\n    if (response.headers['content-length']) {\n      dest.headers['content-length'] = response.headers['content-length']\n    }\n  }\n  if (dest.setHeader) {\n    for (var i in response.headers) {\n      dest.setHeader(i, response.headers[i])\n    }\n    dest.statusCode = response.statusCode\n  }\n  if (this.pipefilter) this.pipefilter(response, dest)\n}\n\n// Composable API\nRequest.prototype.setHeader = function (name, value, clobber) {\n  if (clobber === undefined) clobber = true\n  if (clobber || !this.headers.hasOwnProperty(name)) this.headers[name] = value\n  else this.headers[name] += ',' + value\n  return this\n}\nRequest.prototype.setHeaders = function (headers) {\n  for (var i in headers) {this.setHeader(i, headers[i])}\n  return this\n}\nRequest.prototype.qs = function (q, clobber) {\n  var base\n  if (!clobber && this.uri.query) base = qs.parse(this.uri.query)\n  else base = {}\n  \n  for (var i in q) {\n    base[i] = q[i]\n  }\n\n  if (qs.stringify(base) === ''){\n    return this\n  }\n  \n  this.uri = url.parse(this.uri.href.split('?')[0] + '?' + qs.stringify(base))\n  this.url = this.uri\n  \n  return this\n}\nRequest.prototype.form = function (form) {\n  if (form) {\n    this.headers['content-type'] = 'application/x-www-form-urlencoded; charset=utf-8'\n    this.body = qs.stringify(form).toString('utf8')\n    return this\n  } \n  // create form-data object\n  this._form = new FormData()\n  return this._form\n}\nRequest.prototype.multipart = function (multipart) {\n  var self = this\n  self.body = []\n\n  if (!self.headers['content-type']) {\n    self.headers['content-type'] = 'multipart/related; boundary=' + self.boundary\n  } else {\n    self.headers['content-type'] = self.headers['content-type'].split(';')[0] + '; boundary=' + self.boundary\n  }\n\n  if (!multipart.forEach) throw new Error('Argument error, options.multipart.')\n\n  if (self.preambleCRLF) {\n    self.body.push(new Buffer('\\r\\n'))\n  }\n  \n  multipart.forEach(function (part) {\n    var body = part.body\n    if(body == null) throw Error('Body attribute missing in multipart.')\n    delete part.body\n    var preamble = '--' + self.boundary + '\\r\\n'\n    Object.keys(part).forEach(function (key) {\n      preamble += key + ': ' + part[key] + '\\r\\n'\n    })\n    preamble += '\\r\\n'\n    self.body.push(new Buffer(preamble))\n    self.body.push(new Buffer(body))\n    self.body.push(new Buffer('\\r\\n'))\n  })\n  self.body.push(new Buffer('--' + self.boundary + '--'))\n  return self\n}\nRequest.prototype.json = function (val) {\n  var self = this;\n  var setAcceptHeader = function() {\n  \tif (!self.headers['accept'] && !self.headers['Accept']) {\n\t\t\t  self.setHeader('accept', 'application/json')\n\t\t}\n\t}\n  setAcceptHeader();\n  this._json = true\n  if (typeof val === 'boolean') {\n    if (typeof this.body === 'object') {\n      setAcceptHeader();\n      this.body = safeStringify(this.body)\n      self.setHeader('content-type', 'application/json')\n    }\n  } else {\n    setAcceptHeader();\n    this.body = safeStringify(val)\n    self.setHeader('content-type', 'application/json')\n  }\n  return this\n}\nfunction getHeader(name, headers) {\n    var result, re, match\n    Object.keys(headers).forEach(function (key) {\n        re = new RegExp(name, 'i')\n        match = key.match(re)\n        if (match) result = headers[key]\n    })\n    return result\n}\nRequest.prototype.auth = function (user, pass, sendImmediately) {\n  if (typeof user !== 'string' || typeof pass !== 'string') {\n    throw new Error('auth() received invalid user or password')\n  }\n  this._user = user\n  this._pass = pass\n  this._hasAuth = true\n  if (sendImmediately || typeof sendImmediately == 'undefined') {\n    this.setHeader('authorization', 'Basic ' + toBase64(user + ':' + pass))\n    this._sentAuth = true\n  }\n  return this\n}\nRequest.prototype.aws = function (opts, now) {\n  if (!now) {\n    this._aws = opts\n    return this\n  }\n  var date = new Date()\n  this.setHeader('date', date.toUTCString())\n  var auth =\n    { key: opts.key\n    , secret: opts.secret\n    , verb: this.method.toUpperCase()\n    , date: date\n    , contentType: getHeader('content-type', this.headers) || ''\n    , md5: getHeader('content-md5', this.headers) || ''\n    , amazonHeaders: aws.canonicalizeHeaders(this.headers)\n    }\n  if (opts.bucket && this.path) {\n    auth.resource = '/' + opts.bucket + this.path\n  } else if (opts.bucket && !this.path) {\n    auth.resource = '/' + opts.bucket\n  } else if (!opts.bucket && this.path) {\n    auth.resource = this.path\n  } else if (!opts.bucket && !this.path) {\n    auth.resource = '/'\n  }\n  auth.resource = aws.canonicalizeResource(auth.resource)\n  this.setHeader('authorization', aws.authorization(auth))\n  \n  return this\n}\n\nRequest.prototype.hawk = function (opts) {\n  this.headers.Authorization = hawk.client.header(this.uri, this.method, opts).field\n}\n\nRequest.prototype.oauth = function (_oauth) {\n  var form\n  if (this.headers['content-type'] && \n      this.headers['content-type'].slice(0, 'application/x-www-form-urlencoded'.length) ===\n        'application/x-www-form-urlencoded' \n     ) {\n    form = qs.parse(this.body)\n  }\n  if (this.uri.query) {\n    form = qs.parse(this.uri.query)\n  } \n  if (!form) form = {}\n  var oa = {}\n  for (var i in form) oa[i] = form[i]\n  for (var i in _oauth) oa['oauth_'+i] = _oauth[i]\n  if (!oa.oauth_version) oa.oauth_version = '1.0'\n  if (!oa.oauth_timestamp) oa.oauth_timestamp = Math.floor( Date.now() / 1000 ).toString()\n  if (!oa.oauth_nonce) oa.oauth_nonce = uuid().replace(/-/g, '')\n  \n  oa.oauth_signature_method = 'HMAC-SHA1'\n  \n  var consumer_secret = oa.oauth_consumer_secret\n  delete oa.oauth_consumer_secret\n  var token_secret = oa.oauth_token_secret\n  delete oa.oauth_token_secret\n  var timestamp = oa.oauth_timestamp\n\n  var baseurl = this.uri.protocol + '//' + this.uri.host + this.uri.pathname\n  var signature = oauth.hmacsign(this.method, baseurl, oa, consumer_secret, token_secret)\n  \n  // oa.oauth_signature = signature\n  for (var i in form) {\n    if ( i.slice(0, 'oauth_') in _oauth) {\n      // skip \n    } else {\n      delete oa['oauth_'+i]\n      if (i !== 'x_auth_mode') delete oa[i]\n    }\n  }\n  oa.oauth_timestamp = timestamp\n  this.headers.Authorization =\n    'OAuth '+Object.keys(oa).sort().map(function (i) {return i+'=\"'+oauth.rfc3986(oa[i])+'\"'}).join(',')\n  this.headers.Authorization += ',oauth_signature=\"' + oauth.rfc3986(signature) + '\"'\n  return this\n}\nRequest.prototype.jar = function (jar) {\n  var cookies\n  \n  if (this._redirectsFollowed === 0) {\n    this.originalCookieHeader = this.headers.cookie\n  }\n  \n  if (jar === false) {\n    // disable cookies\n    cookies = false\n    this._disableCookies = true\n  } else if (jar) {\n    // fetch cookie from the user defined cookie jar\n    cookies = jar.get({ url: this.uri.href })\n  } else {\n    // fetch cookie from the global cookie jar\n    cookies = cookieJar.get({ url: this.uri.href })\n  }\n  \n  if (cookies && cookies.length) {\n    var cookieString = cookies.map(function (c) {\n      return c.name + \"=\" + c.value\n    }).join(\"; \")\n\n    if (this.originalCookieHeader) {\n      // Don't overwrite existing Cookie header\n      this.headers.cookie = this.originalCookieHeader + '; ' + cookieString\n    } else {\n      this.headers.cookie = cookieString\n    }\n  }\n  this._jar = jar\n  return this\n}\n\n\n// Stream API\nRequest.prototype.pipe = function (dest, opts) {\n  if (this.response) {\n    if (this._destdata) {\n      throw new Error(\"You cannot pipe after data has been emitted from the response.\")\n    } else if (this._ended) {\n      throw new Error(\"You cannot pipe after the response has been ended.\")\n    } else {\n      stream.Stream.prototype.pipe.call(this, dest, opts)\n      this.pipeDest(dest)\n      return dest\n    }\n  } else {\n    this.dests.push(dest)\n    stream.Stream.prototype.pipe.call(this, dest, opts)\n    return dest\n  }\n}\nRequest.prototype.write = function () {\n  if (!this._started) this.start()\n  return this.req.write.apply(this.req, arguments)\n}\nRequest.prototype.end = function (chunk) {\n  if (chunk) this.write(chunk)\n  if (!this._started) this.start()\n  this.req.end()\n}\nRequest.prototype.pause = function () {\n  if (!this.response) this._paused = true\n  else this.response.pause.apply(this.response, arguments)\n}\nRequest.prototype.resume = function () {\n  if (!this.response) this._paused = false\n  else this.response.resume.apply(this.response, arguments)\n}\nRequest.prototype.destroy = function () {\n  if (!this._ended) this.end()\n  else if (this.response) this.response.destroy()\n}\n\n// organize params for patch, post, put, head, del\nfunction initParams(uri, options, callback) {\n  if ((typeof options === 'function') && !callback) callback = options\n  if (options && typeof options === 'object') {\n    options.uri = uri\n  } else if (typeof uri === 'string') {\n    options = {uri:uri}\n  } else {\n    options = uri\n    uri = options.uri\n  }\n  return { uri: uri, options: options, callback: callback }\n}\n\nfunction request (uri, options, callback) {\n  if (typeof uri === 'undefined') throw new Error('undefined is not a valid uri or options object.')\n  if ((typeof options === 'function') && !callback) callback = options\n  if (options && typeof options === 'object') {\n    options.uri = uri\n  } else if (typeof uri === 'string') {\n    options = {uri:uri}\n  } else {\n    options = uri\n  }\n\n  options = copy(options)\n\n  if (callback) options.callback = callback\n  var r = new Request(options)\n  return r\n}\n\nmodule.exports = request\n\nrequest.debug = process.env.NODE_DEBUG && /request/.test(process.env.NODE_DEBUG)\n\nrequest.initParams = initParams\n\nrequest.defaults = function (options, requester) {\n  var def = function (method) {\n    var d = function (uri, opts, callback) {\n      var params = initParams(uri, opts, callback)\n      for (var i in options) {\n        if (params.options[i] === undefined) params.options[i] = options[i]\n      }\n      if(typeof requester === 'function') {\n        if(method === request) {\n          method = requester\n        } else {\n          params.options._requester = requester\n        }\n      }\n      return method(params.options, params.callback)\n    }\n    return d\n  }\n  var de = def(request)\n  de.get = def(request.get)\n  de.patch = def(request.patch)\n  de.post = def(request.post)\n  de.put = def(request.put)\n  de.head = def(request.head)\n  de.del = def(request.del)\n  de.cookie = def(request.cookie)\n  de.jar = request.jar\n  return de\n}\n\nrequest.forever = function (agentOptions, optionsArg) {\n  var options = {}\n  if (optionsArg) {\n    for (option in optionsArg) {\n      options[option] = optionsArg[option]\n    }\n  }\n  if (agentOptions) options.agentOptions = agentOptions\n  options.forever = true\n  return request.defaults(options)\n}\n\nrequest.get = request\nrequest.post = function (uri, options, callback) {\n  var params = initParams(uri, options, callback)\n  params.options.method = 'POST'\n  return request(params.uri || null, params.options, params.callback)\n}\nrequest.put = function (uri, options, callback) {\n  var params = initParams(uri, options, callback)\n  params.options.method = 'PUT'\n  return request(params.uri || null, params.options, params.callback)\n}\nrequest.patch = function (uri, options, callback) {\n  var params = initParams(uri, options, callback)\n  params.options.method = 'PATCH'\n  return request(params.uri || null, params.options, params.callback)\n}\nrequest.head = function (uri, options, callback) {\n  var params = initParams(uri, options, callback)\n  params.options.method = 'HEAD'\n  if (params.options.body || \n      params.options.requestBodyStream || \n      (params.options.json && typeof params.options.json !== 'boolean') || \n      params.options.multipart) {\n    throw new Error(\"HTTP HEAD requests MUST NOT include a request body.\")\n  }\n  return request(params.uri || null, params.options, params.callback)\n}\nrequest.del = function (uri, options, callback) {\n  var params = initParams(uri, options, callback)\n  params.options.method = 'DELETE'\n  if(typeof params.options._requester === 'function') {\n    request = params.options._requester\n  }\n  return request(params.uri || null, params.options, params.callback)\n}\nrequest.jar = function () {\n  return new CookieJar\n}\nrequest.cookie = function (str) {\n  if (str && str.uri) str = str.uri\n  if (typeof str !== 'string') throw new Error(\"The cookie function only accepts STRING as param\")\n  return new Cookie(str)\n}\n\n// Safe toJSON\n\nfunction getSafe (self, uuid) {  \n  if (typeof self === 'object' || typeof self === 'function') var safe = {}\n  if (Array.isArray(self)) var safe = []\n\n  var recurse = []\n  \n  Object.defineProperty(self, uuid, {})\n  \n  var attrs = Object.keys(self).filter(function (i) {\n    if (i === uuid) return false \n    if ( (typeof self[i] !== 'object' && typeof self[i] !== 'function') || self[i] === null) return true\n    return !(Object.getOwnPropertyDescriptor(self[i], uuid))\n  })\n  \n  \n  for (var i=0;i<attrs.length;i++) {\n    if ( (typeof self[attrs[i]] !== 'object' && typeof self[attrs[i]] !== 'function') || \n          self[attrs[i]] === null\n        ) {\n      safe[attrs[i]] = self[attrs[i]]\n    } else {\n      recurse.push(attrs[i])\n      Object.defineProperty(self[attrs[i]], uuid, {})\n    }\n  }\n\n  for (var i=0;i<recurse.length;i++) {\n    safe[recurse[i]] = getSafe(self[recurse[i]], uuid)\n  }\n  \n  return safe\n}\n\nfunction toJSON () {\n  return getSafe(this, '__' + (((1+Math.random())*0x10000)|0).toString(16))\n}\n\nRequest.prototype.toJSON = toJSON\n"]},"metadata":{},"sourceType":"script"}